<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Sheet | ChauFlow</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        accent: '#10B981',
                        danger: '#EF4444',
                        background: '#F9FAFB',
                        textDark: '#1F2937'
                    }
                }
            }
        }
    </script>
    
    <!-- Mobile Optimizations CSS -->
    <link rel="stylesheet" href="mobile-optimizations.css">
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="confetti-celebration.js"></script>
    <script src="config.js"></script>
    <script src="ai-insights.js"></script>
</head>
<body class="bg-background min-h-screen">
    
    <!-- Navigation Header -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center gap-8">
                    <h1 class="text-xl md:text-2xl font-bold text-primary">ChauFlow</h1>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden md:flex items-center space-x-6">
                        <a href="dashboard.html" class="text-gray-700 hover:text-primary transition-colors duration-200 font-medium">Dashboard</a>
                        <a href="income.html" class="text-gray-700 hover:text-primary transition-colors duration-200 font-medium">Income</a>
                        <a href="expenses.html" class="text-gray-700 hover:text-primary transition-colors duration-200 font-medium">Expenses</a>
                        <a href="balance-sheet.html" class="text-gray-700 hover:text-primary transition-colors duration-200 font-medium">Balance Sheet</a>
                    </div>
                </div>
                
                <!-- User Menu & Mobile Menu Button -->
                <div class="flex items-center gap-3">
                    <!-- Mobile Menu Button (replaces user menu on mobile) -->
                    <button id="mobile-nav-btn" class="md:hidden flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 hover:shadow-md transition-all duration-200 font-medium">
                        <svg id="mobile-menu-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        <svg id="mobile-close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="hidden md:block text-right">
                        <p class="text-xs text-gray-500 mb-0.5">Logged in as</p>
                        <p class="text-sm font-medium text-gray-800" id="user-email">Loading...</p>
                    </div>
                    <div class="relative">
                        <button 
                            id="user-menu-btn"
                            class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 hover:shadow-md transition-all duration-200 font-medium"
                            onclick="toggleUserMenu()"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="user-menu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-50">
                            <div class="px-4 py-2 border-b border-gray-100">
                                <p class="text-xs text-gray-500">Signed in as</p>
                                <p class="text-sm font-semibold text-gray-800 truncate" id="user-email-menu">Loading...</p>
                            </div>
                            <a href="dashboard.html" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                </svg>
                                Dashboard
                            </a>
                            <a href="income.html" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Income
                            </a>
                            <a href="expenses.html" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                Expenses
                            </a>
                            <button class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 opacity-50 cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Settings
                                <span class="ml-auto text-xs text-gray-400">Soon</span>
                            </button>
                            <div class="border-t border-gray-100 mt-1 pt-1">
                                <button 
                                    id="signout-btn"
                                    class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 font-medium"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Navigation Menu -->
            <div id="mobile-nav-menu" class="hidden md:hidden border-t border-gray-200 bg-white">
                <div class="px-4 py-4 space-y-2">
                    <!-- User Info -->
                    <div class="px-4 py-3 bg-gray-50 rounded-lg mb-2">
                        <p class="text-xs text-gray-500 mb-0.5">Logged in as</p>
                        <p class="text-sm font-medium text-gray-800" id="mobile-user-email">Loading...</p>
                    </div>
                    
                    <!-- Navigation Links -->
                    <a href="dashboard.html" class="block px-4 py-3 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-lg transition-colors duration-200">Dashboard</a>
                    <a href="income.html" class="block px-4 py-3 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-lg transition-colors duration-200">Income</a>
                    <a href="expenses.html" class="block px-4 py-3 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-lg transition-colors duration-200">Expenses</a>
                    <a href="balance-sheet.html" class="block px-4 py-3 text-accent bg-green-50 rounded-lg font-medium">Balance Sheet</a>
                    <button onclick="alert('Reports page coming soon!')" class="w-full text-left px-4 py-3 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-lg transition-colors duration-200">Reports</button>
                    
                    <!-- Sign Out Button -->
                    <button id="mobile-signout-btn" class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200 font-medium flex items-center gap-2 border-t border-gray-200 mt-2 pt-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 safe-area-bottom shadow-lg">
        <div class="grid grid-cols-4 h-16">
            <a href="dashboard.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs font-medium">Home</span>
            </a>
            <a href="income.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-xs font-medium">Income</span>
            </a>
            <a href="expenses.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <span class="text-xs font-medium">Expenses</span>
            </a>
            <a href="balance-sheet.html" class="flex flex-col items-center justify-center text-primary bg-blue-50 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <span class="text-xs font-medium">Balance Sheet</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 md:py-8 pb-20 md:pb-8">
        
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Business Net Worth</h1>
            <p class="text-base text-gray-600">Track what you own and what you owe</p>
        </div>
        
        <!-- Quick Filters -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6">
            <label for="balance-sheet-filter-select" class="block text-sm font-medium text-gray-700 mb-3">Time Period</label>
            <select id="balance-sheet-filter-select" onchange="applyBalanceSheetQuickFilter(this.value)" class="w-full md:w-64 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-gray-700 font-medium">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="thisMonth">This Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="last30Days">Last 30 Days</option>
                <option value="last90Days">Last 90 Days</option>
                <option value="thisYear">This Year</option>
                <option value="lastYear">Last Year</option>
                <option value="allTime" selected>All Time</option>
            </select>
        </div>

        <!-- Summary Cards - 3 Metrics -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <!-- Total Assets Card -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-start justify-between mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <button class="group/tooltip relative" onmouseenter="showTooltip('assets-tooltip')" onmouseleave="hideTooltip('assets-tooltip')">
                        <svg class="w-5 h-5 text-gray-400 hover:text-green-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div id="assets-tooltip" class="hidden absolute bottom-full right-0 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50 shadow-xl">
                            Everything your business owns: vehicles, equipment, and cash.
                            <div class="absolute top-full right-4 -mt-1">
                                <div class="border-4 border-transparent border-t-gray-900"></div>
                            </div>
                        </div>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mb-1">What You Own</p>
                <div id="total-assets-summary-loading" class="h-10 bg-gray-200 rounded animate-pulse mb-2"></div>
                <p id="total-assets-summary" class="text-3xl font-bold text-accent hidden"></p>
                <p class="text-xs text-gray-500 mt-2">Total Assets</p>
            </div>

            <!-- Total Liabilities Card -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-start justify-between mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                    </div>
                    <button class="group/tooltip relative" onmouseenter="showTooltip('liabilities-tooltip')" onmouseleave="hideTooltip('liabilities-tooltip')">
                        <svg class="w-5 h-5 text-gray-400 hover:text-red-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div id="liabilities-tooltip" class="hidden absolute bottom-full right-0 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50 shadow-xl">
                            What your business owes: loans, leases, credit cards.
                            <div class="absolute top-full right-4 -mt-1">
                                <div class="border-4 border-transparent border-t-gray-900"></div>
                            </div>
                        </div>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mb-1">What You Owe</p>
                <div id="total-liabilities-summary-loading" class="h-10 bg-gray-200 rounded animate-pulse mb-2"></div>
                <p id="total-liabilities-summary" class="text-3xl font-bold text-danger hidden"></p>
                <p class="text-xs text-gray-500 mt-2">Total Liabilities</p>
            </div>

            <!-- Net Worth Card -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-start justify-between mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <button class="group/tooltip relative" onmouseenter="showTooltip('net-worth-tooltip')" onmouseleave="hideTooltip('net-worth-tooltip')">
                        <svg class="w-5 h-5 text-gray-400 hover:text-blue-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div id="net-worth-tooltip" class="hidden absolute bottom-full right-0 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50 shadow-xl">
                            What your business is really worth â€” your assets minus what you owe.
                            <div class="absolute top-full right-4 -mt-1">
                                <div class="border-4 border-transparent border-t-gray-900"></div>
                            </div>
                        </div>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mb-1">Business Net Worth</p>
                <div id="net-worth-loading" class="h-10 bg-gray-200 rounded animate-pulse mb-2"></div>
                <p id="net-worth" class="text-3xl font-bold text-primary hidden"></p>
                <p class="text-xs text-gray-500 mt-2" id="net-worth-formula"></p>
            </div>
        </div>

        <!-- ChaufAI Insight -->
        <div id="ai-insight-container" class="mb-8">
            <!-- AI insight will be loaded here -->
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- ASSETS Column -->
            <div class="bg-green-50 rounded-2xl p-6 shadow-sm border-2 border-green-200">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                What You Own
                            </h2>
                            <p class="text-sm text-green-700 ml-12">Your business assets</p>
                        </div>
                        <button 
                            onclick="openAssetModal()"
                            class="inline-flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all duration-200 shadow-sm hover:shadow-md"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Asset
                        </button>
                    </div>
                    <!-- Help Text -->
                    <div class="bg-green-50 border border-green-200 rounded-lg px-4 py-3">
                        <p class="text-sm text-green-800">
                            <span class="font-semibold">Examples:</span> Cadillac Escalade, iPhone used for dispatch, business savings account
                        </p>
                    </div>
                </div>

                <!-- Assets List -->
                <div class="space-y-4" id="assets-list">
                    <!-- Asset cards will be inserted here -->
                </div>

                <!-- Empty State - Assets -->
                <div id="assets-empty" class="hidden bg-white rounded-xl shadow-md p-8 text-center">
                    <svg class="mx-auto w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No assets yet</h3>
                    <p class="text-gray-600 mb-4">Add your vehicles, equipment, or other business assets</p>
                    <button onclick="openAssetModal()" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-green-600">
                        Add Your First Asset
                    </button>
                </div>
            </div>

            <!-- LIABILITIES Column -->
            <div class="bg-red-50 rounded-2xl p-6 shadow-sm border-2 border-red-200">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
                                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                    </svg>
                                </div>
                                What You Owe
                            </h2>
                            <p class="text-sm text-red-700 ml-12">Your business debts</p>
                        </div>
                        <button 
                            onclick="openLiabilityModal()"
                            class="inline-flex items-center gap-2 px-5 py-2.5 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-all duration-200 shadow-sm hover:shadow-md"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Liability
                        </button>
                    </div>
                    <!-- Help Text -->
                    <div class="bg-red-50 border border-red-200 rounded-lg px-4 py-3">
                        <p class="text-sm text-red-800">
                            <span class="font-semibold">Examples:</span> Auto loan, credit card for gas, iPhone financing, business line of credit
                        </p>
                    </div>
                </div>

                <!-- Liabilities List -->
                <div class="space-y-4" id="liabilities-list">
                    <!-- Liability cards will be inserted here -->
                </div>

                <!-- Empty State - Liabilities -->
                <div id="liabilities-empty" class="hidden bg-white rounded-xl shadow-md p-8 text-center">
                    <svg class="mx-auto w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No liabilities yet</h3>
                    <p class="text-gray-600 mb-4">Track your loans, leases, or other business debts</p>
                    <button onclick="openLiabilityModal()" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-600">
                        Add Your First Liability
                    </button>
                </div>
            </div>
        </div>

        <!-- Owner's Equity Section -->
        <div class="mt-12">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                Owner's Equity
                            </h2>
                            <p class="text-sm text-slate-600 ml-12">Track your contributions and draws</p>
                        </div>
                        <div class="flex gap-2">
                            <button 
                                onclick="openEquityModal('contribution')"
                                class="inline-flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 shadow-sm hover:shadow-md">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Contribution
                            </button>
                            <button 
                                onclick="openEquityModal('draw')"
                                class="inline-flex items-center gap-2 px-4 py-2.5 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition-all duration-200 shadow-sm hover:shadow-md">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                </svg>
                                Record Draw
                            </button>
                        </div>
                    </div>
                    
                    <!-- Equity Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <!-- Total Contributions -->
                        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                            <p class="text-xs text-slate-600 font-medium mb-2">Total Contributions</p>
                            <div id="total-contributions-loading" class="h-8 w-24 bg-gray-200 rounded animate-pulse"></div>
                            <p id="total-contributions" class="text-2xl font-bold text-blue-600 hidden"></p>
                            <p class="text-xs text-slate-500 mt-1">Money you invested</p>
                        </div>
                        
                        <!-- Total Draws -->
                        <div class="bg-orange-50 border-l-4 border-orange-500 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                            <p class="text-xs text-slate-600 font-medium mb-2">Total Draws</p>
                            <div id="total-draws-loading" class="h-8 w-24 bg-gray-200 rounded animate-pulse"></div>
                            <p id="total-draws" class="text-2xl font-bold text-orange-600 hidden"></p>
                            <p class="text-xs text-slate-500 mt-1">Money you took out</p>
                        </div>
                        
                        <!-- Net Equity -->
                        <div class="bg-blue-600 rounded-lg p-4 text-white shadow-lg ring-2 ring-blue-200 hover:shadow-xl transition-all duration-200">
                            <p class="text-xs text-blue-100 font-medium mb-2">Net Owner's Equity</p>
                            <div id="net-equity-loading" class="h-8 w-24 bg-white/20 rounded animate-pulse"></div>
                            <p id="net-equity" class="text-2xl font-bold hidden"></p>
                            <p class="text-xs text-blue-100 mt-1">Contributions - Draws</p>
                        </div>
                    </div>

                    <!-- Help Text -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-3">
                        <p class="text-sm text-blue-900">
                            <span class="font-semibold">ðŸ’¡ What's the difference?</span> 
                            <strong>Contributions</strong> are money you put into your business. 
                            <strong>Draws</strong> are money you take out for personal use. 
                            Neither affects your profit/loss â€” they only change your equity.
                        </p>
                    </div>
                </div>

                <!-- Equity Transactions List -->
                <div class="space-y-4" id="equity-list">
                    <!-- Equity transaction cards will be inserted here -->
                </div>

                <!-- Empty State - Equity -->
                <div id="equity-empty" class="hidden bg-gray-50 rounded-xl p-8 text-center border border-gray-200">
                    <svg class="mx-auto w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No equity transactions yet</h3>
                    <p class="text-gray-600 mb-4">Start tracking your contributions and draws</p>
                    <div class="flex gap-2 justify-center">
                        <button onclick="openEquityModal('contribution')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            Add Contribution
                        </button>
                        <button onclick="openEquityModal('draw')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-medium">
                            Record Draw
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-xl p-6">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="flex-1">
                    <h4 class="font-bold text-blue-900 mb-2 text-lg">What is a Balance Sheet?</h4>
                    <p class="text-sm text-blue-800 mb-4 leading-relaxed">
                        A balance sheet shows what your business owns and what it owes. 
                        The difference is your net worth â€” a snapshot of your business's financial health.
                    </p>
                    <ul class="text-sm text-blue-800 space-y-2 mb-5">
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span><strong>What You Own:</strong> Your vehicles, equipment, and cash</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span><strong>What You Owe:</strong> Your loans, leases, and debts</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span><strong>Business Net Worth:</strong> What you own minus what you owe</span>
                        </li>
                    </ul>
                    
                    <div class="border-t border-blue-300 pt-4 mt-4">
                        <h5 class="font-bold text-blue-900 mb-2">Why This Matters:</h5>
                        <p class="text-sm text-blue-800 leading-relaxed">
                            Your business net worth is often needed when applying for financing, buying new cars, or proving your income as a business owner. 
                            Keeping this page updated helps show that your business is healthy and organized.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
    
    <!-- Add Asset Modal -->
    <div id="asset-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75 backdrop-blur-sm" onclick="closeAssetModal()"></div>
            
            <!-- Modal panel -->
            <div class="relative bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-gray-900">Add Asset</h3>
                        <button onclick="closeAssetModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Visual Hint Bar -->
                    <div class="mb-6 bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-sm text-green-800">
                                <strong>Assets increase your net worth.</strong> Don't forget your vehicles, gear, or business cash!
                            </p>
                        </div>
                    </div>
                    
                    <form id="asset-form" class="space-y-5">
                        <!-- Asset Name -->
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Asset Name *</label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('asset-name-tip')" onmouseleave="hideTooltip('asset-name-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="asset-name-tip" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-56 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Give it a clear name like "2023 Escalade" or "iPhone 14 Pro"
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <input type="text" id="asset-name" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                                placeholder="e.g., 2022 Escalade"
                                oninput="autoSuggestAssetType()">
                        </div>
                        
                        <!-- Asset Type -->
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Type *</label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('asset-type-tip')" onmouseleave="hideTooltip('asset-type-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="asset-type-tip" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Choose the category that best describes this asset
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <select id="asset-type" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                                onchange="updateAssetTypeDescription()">
                                <option value="">Select asset type</option>
                                <option value="vehicle" data-desc="Cars used for work, e.g., Suburban or Escalade">Fleet Vehicle</option>
                                <option value="equipment" data-desc="Dashcams, phone mounts, tablets, chargers, etc.">Equipment & Accessories</option>
                                <option value="cash" data-desc="Business checking or savings account balance">Business Bank Account</option>
                                <option value="receivable" data-desc="Money clients owe you for completed jobs">Unpaid Client Invoices</option>
                                <option value="other" data-desc="Any other business asset not listed above">Other Asset</option>
                            </select>
                            <p id="asset-type-description" class="mt-2 text-xs text-gray-600 italic hidden"></p>
                        </div>
                        
                        <!-- Current Value -->
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Current Value *</label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('asset-value-tip')" onmouseleave="hideTooltip('asset-value-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="asset-value-tip" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Estimate today's resale value, not what you originally paid
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                <input type="text" id="asset-value" inputmode="numeric" required
                                    class="w-full pl-8 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                                    placeholder="0"
                                    oninput="formatCurrency(this)">
                                <button type="button" onclick="openCalculator('asset')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-accent transition-colors" title="Calculator">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                            <p class="mt-1 text-xs text-blue-600">
                                <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Estimate today's resale value, not what you paid
                            </p>
                        </div>
                        
                        <!-- Purchase Date & Purchase Price (for depreciation) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Purchase Date (Optional)</label>
                                <input type="date" id="asset-purchase-date"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Purchase Price (Optional)</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                    <input type="text" id="asset-purchase-price" inputmode="numeric"
                                        class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                                        placeholder="0"
                                        oninput="formatCurrency(this)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Track Depreciation Toggle -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="track-depreciation" class="w-4 h-4 text-accent rounded focus:ring-accent">
                                    <span class="text-sm font-semibold text-gray-700">Track depreciation?</span>
                                </label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('depreciation-tip')" onmouseleave="hideTooltip('depreciation-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="depreciation-tip" class="hidden absolute bottom-full right-0 mb-2 w-72 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Track how your asset loses value over time. Useful for tax deductions!
                                        <div class="absolute top-full right-4 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <div id="depreciation-fields" class="hidden mt-3 space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Useful Life (years)</label>
                                    <input type="number" id="useful-life" min="1" max="30" value="5"
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent">
                                </div>
                                <p class="text-xs text-gray-600">We'll use straight-line depreciation to calculate annual value loss.</p>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Notes (Optional)</label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('asset-notes-tip')" onmouseleave="hideTooltip('asset-notes-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="asset-notes-tip" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Add details like VIN, mileage, condition, or storage location
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <textarea id="asset-notes" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent resize-none"
                                placeholder="e.g., VIN: 1GNSKCKD5JR123456, 45,000 miles, excellent condition, garaged"></textarea>
                        </div>
                        
                        <!-- Loan/Financing Section -->
                        <div class="border-t border-gray-200 pt-5">
                            <div class="flex items-center justify-between mb-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="has-loan" class="w-4 h-4 text-primary rounded focus:ring-primary" onchange="toggleLoanFields()">
                                    <span class="text-sm font-semibold text-gray-700">Did you take out a loan for this asset?</span>
                                </label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('loan-tip')" onmouseleave="hideTooltip('loan-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="loan-tip" class="hidden absolute bottom-full right-0 mb-2 w-72 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        If you financed this asset, we'll automatically add it to "What You Owe" so you don't have to do it separately!
                                        <div class="absolute top-full right-4 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            
                            <!-- Loan Fields (Hidden by default) -->
                            <div id="loan-fields" class="hidden space-y-4 bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <div class="flex items-start gap-2 mb-3">
                                    <svg class="w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <p class="text-xs text-orange-800">
                                        <strong>We'll add this loan to "What You Owe"</strong> automatically. This saves you time!
                                    </p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Lender/Bank</label>
                                        <input type="text" id="loan-lender"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                            placeholder="e.g., Chase Bank">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Balance Owed</label>
                                        <div class="relative">
                                            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                            <input type="text" id="loan-balance" inputmode="numeric"
                                                class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="0"
                                                oninput="formatCurrency(this)">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Interest Rate (Optional)</label>
                                        <div class="relative">
                                            <input type="text" id="loan-interest-rate" inputmode="decimal"
                                                class="w-full px-4 pr-8 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="0.00">
                                            <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Payment (Optional)</label>
                                        <div class="relative">
                                            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                            <input type="text" id="loan-monthly-payment" inputmode="numeric"
                                                class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                                placeholder="0"
                                                oninput="formatCurrency(this)">
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Loan Notes (Optional)</label>
                                    <textarea id="loan-notes" rows="2"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                                        placeholder="e.g., 60-month term, started Jan 2023"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error Message -->
                        <div id="asset-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                            <p class="text-sm text-red-600 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span id="asset-error-message"></span>
                            </p>
                        </div>
                        
                        <!-- Success Message -->
                        <div id="asset-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-600 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                Asset added successfully!
                            </p>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="closeAssetModal()"
                                class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" id="asset-submit-btn"
                                class="flex-1 px-4 py-3 bg-accent text-white rounded-lg font-semibold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Asset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Liability Modal -->
    <div id="liability-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75 backdrop-blur-sm" onclick="closeLiabilityModal()"></div>
            
            <!-- Modal panel -->
            <div class="relative bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-gray-900">Add Liability</h3>
                        <button onclick="closeLiabilityModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Visual Hint Bar -->
                    <div class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-sm text-red-800">
                                <strong>Liabilities reduce your net worth.</strong> These are debts or obligations your business has.
                            </p>
                        </div>
                    </div>
                    
                    <form id="liability-form" class="space-y-5">
                        <!-- Liability Name -->
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Liability Name *</label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('liability-name-tip')" onmouseleave="hideTooltip('liability-name-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="liability-name-tip" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-56 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Give it a clear name like "Auto Loan - Escalade" or "Chase Credit Card"
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <input type="text" id="liability-name" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-danger focus:border-transparent"
                                placeholder="e.g., Auto Loan - Escalade">
                        </div>
                        
                        <!-- Liability Type -->
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Type *</label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('liability-type-tip')" onmouseleave="hideTooltip('liability-type-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="liability-type-tip" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Choose the category that best describes this debt
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <select id="liability-type" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-danger focus:border-transparent"
                                onchange="updateLiabilityTypeDescription()">
                                <option value="">Select liability type</option>
                                <option value="auto_loan" data-desc="Money owed on a car you're financing">Auto Loan</option>
                                <option value="lease" data-desc="Monthly lease payments for a vehicle you don't own">Vehicle Lease</option>
                                <option value="credit_card" data-desc="Outstanding balance on business credit cards">Credit Card Balance</option>
                                <option value="tax" data-desc="Income or sales taxes owed to the government">Tax Payable</option>
                                <option value="other" data-desc="Zelle IOUs, personal loans, or other debts">Other Debt</option>
                            </select>
                            <p id="liability-type-description" class="mt-2 text-xs text-gray-600 italic hidden"></p>
                        </div>
                        
                        <!-- Link to Asset (if applicable) -->
                        <div id="link-to-asset-section" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start gap-3 mb-3">
                                <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p class="text-xs text-blue-800">
                                    <strong>Tip:</strong> If this debt is related to a car in your Assets, make sure the names match for clear tracking.
                                </p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-2">Link to Asset (Optional)</label>
                                <select id="linked-asset" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-danger focus:border-transparent">
                                    <option value="">Not linked to any asset</option>
                                    <!-- Will be populated dynamically with vehicle assets -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Current Balance -->
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Balance Owed *</label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('liability-balance-tip')" onmouseleave="hideTooltip('liability-balance-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="liability-balance-tip" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Enter the total amount you currently owe
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                <input type="text" id="liability-balance" inputmode="numeric" required
                                    class="w-full pl-8 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-danger focus:border-transparent"
                                    placeholder="0"
                                    oninput="formatCurrency(this)">
                                <button type="button" onclick="openCalculator('liability')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-danger transition-colors" title="Calculator">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Next Payment Date & Monthly Payment -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Next Payment Date</label>
                                <input type="date" id="liability-due-date"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-danger focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Monthly Payment</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                    <input type="text" id="monthly-payment" inputmode="numeric"
                                        class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-danger focus:border-transparent"
                                        placeholder="0"
                                        oninput="formatCurrency(this)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Notes (Optional)</label>
                                <button type="button" class="group relative" onmouseenter="showTooltip('liability-notes-tip')" onmouseleave="hideTooltip('liability-notes-tip')">
                                    <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div id="liability-notes-tip" class="hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50">
                                        Add details like APR, payment terms, or lender info
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                            <div class="border-4 border-transparent border-t-gray-900"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <textarea id="liability-notes" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-danger focus:border-transparent resize-none"
                                placeholder="e.g., 4.5% APR, 60-month term, Bank of America"></textarea>
                        </div>
                        
                        <!-- Error Message -->
                        <div id="liability-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                            <p class="text-sm text-red-600 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span id="liability-error-message"></span>
                            </p>
                        </div>
                        
                        <!-- Success Message -->
                        <div id="liability-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-600 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                Liability added successfully!
                            </p>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="closeLiabilityModal()"
                                class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" id="liability-submit-btn"
                                class="flex-1 px-4 py-3 bg-danger text-white rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Liability
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PAYMENT MODAL -->
    <!-- ============================================ -->
    <div id="payment-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" onclick="closePaymentModal()"></div>
            
            <!-- Modal panel -->
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-6 pt-6 pb-4">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Make Payment</h2>
                        <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Info Banner -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 mb-5">
                        <div class="flex gap-2">
                            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div>
                                <p class="text-sm font-semibold text-blue-900 mb-1">How Loan Payments Work</p>
                                <p class="text-xs text-blue-800">Your payment has two parts: <strong>Principal</strong> (reduces the loan) and <strong>Interest</strong> (recorded as an expense).</p>
                            </div>
                        </div>
                    </div>

                    <!-- Liability Info -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-5">
                        <p class="text-xs text-gray-500 mb-1">Making payment for:</p>
                        <p class="text-lg font-bold text-gray-900" id="payment-liability-name">-</p>
                        <p class="text-sm text-gray-600 mt-1">Current Balance: <span class="font-semibold text-danger" id="payment-current-balance">$0.00</span></p>
                    </div>

                    <!-- Payment Form -->
                    <form id="payment-form" class="space-y-5">
                        <!-- Payment Date -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">
                                Payment Date *
                            </label>
                            <input type="date" id="payment-date" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent">
                        </div>

                        <!-- Total Payment Amount -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">
                                Total Payment Amount *
                            </label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">$</span>
                                <input type="text" id="payment-total" inputmode="numeric" required
                                    oninput="formatPaymentCurrency(this); calculatePrincipal()"
                                    class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
                                    placeholder="0.00">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">The full amount you're paying today</p>
                        </div>

                        <!-- Interest Amount -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">
                                Interest Amount *
                            </label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">$</span>
                                <input type="text" id="payment-interest" inputmode="numeric" required
                                    oninput="formatPaymentCurrency(this); calculatePrincipal()"
                                    class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
                                    placeholder="0.00">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">The interest portion (will be recorded as an expense)</p>
                        </div>

                        <!-- Principal Amount (Auto-calculated) -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-green-700 mb-1">Principal Amount (Auto-calculated)</p>
                                    <p class="text-2xl font-bold text-green-800" id="payment-principal-display">$0.00</p>
                                </div>
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p class="text-xs text-green-700 mt-2">This amount will reduce your loan balance</p>
                        </div>

                        <!-- Notes (Optional) -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">
                                Notes (Optional)
                            </label>
                            <textarea id="payment-notes" rows="2"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent resize-none"
                                placeholder="e.g., Check #1234, confirmation number"></textarea>
                        </div>

                        <!-- Error Message -->
                        <div id="payment-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                            <div class="flex gap-2">
                                <svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm text-red-800" id="payment-error-message"></span>
                            </div>
                        </div>

                        <!-- Success Message -->
                        <div id="payment-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-800 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                Payment recorded successfully!
                            </p>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="closePaymentModal()"
                                class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" id="payment-submit-btn"
                                class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Record Payment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- OWNER'S EQUITY MODAL -->
    <!-- ============================================ -->
    <div id="equity-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75" onclick="closeEquityModal()"></div>
            
            <!-- Modal panel -->
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-6 pt-6 pb-4">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900" id="equity-modal-title">Add Transaction</h2>
                        <button onclick="closeEquityModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Info Banner -->
                    <div id="equity-info-banner" class="bg-purple-50 border border-purple-200 rounded-lg px-4 py-3 mb-5">
                        <div class="flex gap-2">
                            <svg class="w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div>
                                <p class="text-sm font-semibold text-purple-900 mb-1" id="equity-info-title">About This Transaction</p>
                                <p class="text-xs text-purple-800" id="equity-info-text">Information about the transaction type</p>
                            </div>
                        </div>
                    </div>

                    <!-- Equity Form -->
                    <form id="equity-form" class="space-y-5">
                        <input type="hidden" id="equity-transaction-type" value="">
                        
                        <!-- Date -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">
                                Date *
                            </label>
                            <input type="date" id="equity-date" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                        </div>

                        <!-- Amount -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">
                                Amount *
                            </label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">$</span>
                                <input type="text" id="equity-amount" inputmode="numeric" required
                                    oninput="formatEquityCurrency(this)"
                                    class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                                    placeholder="0.00">
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">
                                Description *
                            </label>
                            <input type="text" id="equity-description" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                                placeholder="e.g., Initial investment, Personal expenses">
                        </div>

                        <!-- Notes (Optional) -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-900 mb-2">
                                Notes (Optional)
                            </label>
                            <textarea id="equity-notes" rows="2"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent resize-none"
                                placeholder="Additional details..."></textarea>
                        </div>

                        <!-- Error Message -->
                        <div id="equity-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                            <div class="flex gap-2">
                                <svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-sm text-red-800" id="equity-error-message"></span>
                            </div>
                        </div>

                        <!-- Success Message -->
                        <div id="equity-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-800 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                Transaction recorded successfully!
                            </p>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="closeEquityModal()"
                                class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" id="equity-submit-btn"
                                class="flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span id="equity-submit-text">Record Transaction</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="mt-16 py-8 px-4 bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto text-center text-sm text-gray-500">
            <p>&copy; 2025 ChauFlow. All rights reserved.</p>
        </div>
    </footer>
    
    <script>
        // ============================================
        // Supabase Configuration
        // ============================================
        
        const SUPABASE_URL = 'https://bvrdimwnarfobmwvthyb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2cmRpbXduYXJmb2Jtd3Z0aHliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMjAxMzcsImV4cCI6MjA3Nzc5NjEzN30.vweZ-F-sG4rYJT1CM1OH0QONmEt73_TMV0F-emMuj8k';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let allAssets = [];
        let allLiabilities = [];
        
        // ============================================
        // Authentication Check
        // ============================================
        
        async function checkAuth() {
            console.log('Checking auth on balance sheet page...');
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) {
                console.error('Auth error:', error);
                window.location.href = 'login.html?redirect=balance-sheet.html';
                return;
            }
            
            if (!session) {
                console.log('No session found, redirecting to login');
                window.location.href = 'login.html?redirect=balance-sheet.html';
                return;
            }
            
            console.log('Session found, loading page for user:', session.user.email);
            currentUser = session.user;
            
            const userEmailElement = document.getElementById('user-email');
            const userEmailMenu = document.getElementById('user-email-menu');
            
            if (userEmailElement) {
                userEmailElement.textContent = currentUser.email || 'Driver';
            }
            if (userEmailMenu) {
                userEmailMenu.textContent = currentUser.email || 'Driver';
            }
            
            // Update email in mobile menu
            const mobileUserEmail = document.getElementById('mobile-user-email');
            if (mobileUserEmail) {
                mobileUserEmail.textContent = currentUser.email || 'Driver';
            }
            
            // Load data
            await loadAllBalanceSheetData();
        }
        
        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            if (event === 'SIGNED_OUT') {
                console.log('User signed out, redirecting to login');
                window.location.href = 'login.html';
            }
        });
        
        // ============================================
        // User Menu Functions
        // ============================================
        
        // Mobile Navigation Toggle
        const mobileNavBtn = document.getElementById('mobile-nav-btn');
        const mobileNavMenu = document.getElementById('mobile-nav-menu');
        const mobileMenuIcon = document.getElementById('mobile-menu-icon');
        const mobileCloseIcon = document.getElementById('mobile-close-icon');

        if (mobileNavBtn) {
            mobileNavBtn.addEventListener('click', () => {
                mobileNavMenu.classList.toggle('hidden');
                mobileMenuIcon.classList.toggle('hidden');
                mobileCloseIcon.classList.toggle('hidden');
            });
        }

        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('user-menu');
            const menuBtn = document.getElementById('user-menu-btn');
            if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });
        
        // Sign out handler
        // Sign out handlers (desktop and mobile)
        const handleSignOut = async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error signing out:', error);
            } else {
                window.location.href = 'login.html';
            }
        };
        
        document.getElementById('signout-btn').addEventListener('click', handleSignOut);
        
        const mobileSignoutBtn = document.getElementById('mobile-signout-btn');
        if (mobileSignoutBtn) {
            mobileSignoutBtn.addEventListener('click', handleSignOut);
        }
        
        // ============================================
        // Quick Filter Functions
        // ============================================
        
        let currentBalanceSheetFilter = 'allTime'; // Default to All Time for Balance Sheet
        
        function applyBalanceSheetQuickFilter(filterType) {
            currentBalanceSheetFilter = filterType;
            
            // Update button styles
            document.querySelectorAll('.balance-sheet-filter-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-100', 'text-gray-700');
            event.target.classList.add('bg-primary', 'text-white');
            
            // Reload data with new filter
            await loadAllBalanceSheetData();
        }
        
        function getBalanceSheetDateRange() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (currentBalanceSheetFilter) {
                case 'today':
                    return {
                        start: today.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    return {
                        start: yesterday.toISOString().split('T')[0],
                        end: yesterday.toISOString().split('T')[0]
                    };
                case 'thisMonth':
                    return {
                        start: new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0],
                        end: new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]
                    };
                case 'lastMonth':
                    return {
                        start: new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0],
                        end: new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0]
                    };
                case 'last30Days':
                    const last30 = new Date(today);
                    last30.setDate(today.getDate() - 30);
                    return {
                        start: last30.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'last90Days':
                    const last90 = new Date(today);
                    last90.setDate(today.getDate() - 90);
                    return {
                        start: last90.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'thisYear':
                    return {
                        start: new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'lastYear':
                    return {
                        start: new Date(now.getFullYear() - 1, 0, 1).toISOString().split('T')[0],
                        end: new Date(now.getFullYear() - 1, 11, 31).toISOString().split('T')[0]
                    };
                case 'allTime':
                default:
                    return { start: null, end: null };
            }
        }
        
        // ============================================
        // Load All Balance Sheet Data (Coordinated)
        // ============================================
        
        async function loadAllBalanceSheetData() {
            try {
                // Show loading state for AI insight
                displayInsight('ai-insight-container', '', true);
                
                // Load all data in parallel
                const [assetsData, liabilitiesData, equityData] = await Promise.all([
                    loadAssetsData(),
                    loadLiabilitiesData(),
                    loadOwnerEquityData()
                ]);
                
                // Render all sections
                renderAssets(assetsData.assets, assetsData.totalAssets);
                renderLiabilities(liabilitiesData.liabilities, liabilitiesData.totalLiabilities);
                renderOwnerEquity(equityData.transactions, equityData.totalContributions, equityData.totalDraws, equityData.netEquity);
                
                // Update net worth
                const netWorth = assetsData.totalAssets - liabilitiesData.totalLiabilities;
                updateNetWorth(netWorth, assetsData.totalAssets, liabilitiesData.totalLiabilities);
                
                // Prepare data for AI insight
                const insightData = {
                    summary: {
                        totalAssets: assetsData.totalAssets,
                        totalLiabilities: liabilitiesData.totalLiabilities,
                        netWorth: netWorth,
                        totalContributions: equityData.totalContributions,
                        totalDraws: equityData.totalDraws,
                        netEquity: equityData.netEquity
                    },
                    assets: assetsData.assets.slice(0, 10).map(a => ({
                        name: a.asset_name,
                        type: a.asset_type,
                        value: parseFloat(a.current_value),
                        date: a.purchase_date,
                        description: a.description || ''
                    })),
                    liabilities: liabilitiesData.liabilities.slice(0, 10).map(l => ({
                        name: l.liability_name,
                        type: l.liability_type,
                        balance: parseFloat(l.current_balance),
                        date: l.date_incurred,
                        description: l.description || ''
                    })),
                    equity: equityData.transactions.slice(0, 10).map(e => ({
                        type: e.transaction_type,
                        amount: parseFloat(e.amount),
                        date: e.transaction_date,
                        description: e.description || ''
                    }))
                };
                
                // Load AI insight
                await loadBalanceSheetInsight(insightData);
                
            } catch (error) {
                console.error('Error loading balance sheet data:', error);
            }
        }
        
        // ============================================
        // Load Assets Data (Returns data without rendering)
        // ============================================
        
        async function loadAssetsData() {
            const dateRange = getBalanceSheetDateRange();
            
            let query = supabase
                .from('assets')
                .select('*')
                .eq('user_id', currentUser.id);
            
            if (dateRange.start) {
                query = query.gte('purchase_date', dateRange.start);
            }
            if (dateRange.end) {
                query = query.lte('purchase_date', dateRange.end);
            }
            
            const { data, error } = await query.order('purchase_date', { ascending: false });
            
            if (error) throw error;
            
            const totalAssets = data.reduce((sum, asset) => sum + parseFloat(asset.current_value), 0);
            
            return { assets: data, totalAssets };
        }
        
        // ============================================
        // Load Liabilities Data (Returns data without rendering)
        // ============================================
        
        async function loadLiabilitiesData() {
            const dateRange = getBalanceSheetDateRange();
            
            let query = supabase
                .from('liabilities')
                .select('*')
                .eq('user_id', currentUser.id);
            
            if (dateRange.start) {
                query = query.gte('created_at', dateRange.start);
            }
            if (dateRange.end) {
                const endDate = new Date(dateRange.end);
                endDate.setDate(endDate.getDate() + 1);
                query = query.lt('created_at', endDate.toISOString().split('T')[0]);
            }
            
            const { data, error } = await query.order('created_at', { ascending: false });
            
            if (error) throw error;
            
            const totalLiabilities = data.reduce((sum, liability) => sum + parseFloat(liability.current_balance), 0);
            
            return { liabilities: data, totalLiabilities };
        }
        
        // ============================================
        // Load Owner Equity Data (Returns data without rendering)
        // ============================================
        
        async function loadOwnerEquityData() {
            const dateRange = getBalanceSheetDateRange();
            
            let query = supabase
                .from('owner_equity')
                .select('*')
                .eq('user_id', currentUser.id);
            
            if (dateRange.start) {
                query = query.gte('transaction_date', dateRange.start);
            }
            if (dateRange.end) {
                query = query.lte('transaction_date', dateRange.end);
            }
            
            const { data, error } = await query.order('transaction_date', { ascending: false });
            
            if (error) throw error;
            
            const contributions = data.filter(t => t.transaction_type === 'contribution');
            const draws = data.filter(t => t.transaction_type === 'draw');
            
            const totalContributions = contributions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalDraws = draws.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const netEquity = totalContributions - totalDraws;
            
            return { transactions: data, totalContributions, totalDraws, netEquity };
        }
        
        // ============================================
        // Load Assets (Legacy - calls loadAllBalanceSheetData)
        // ============================================
        
        async function loadAssets() {
            try {
                // Get date range from quick filter
                const dateRange = getBalanceSheetDateRange();
                
                let query = supabase
                    .from('assets')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                // Apply date filter if not "All Time"
                if (dateRange.start) {
                    query = query.gte('created_at', dateRange.start);
                }
                if (dateRange.end) {
                    // Add one day to include items created on end date
                    const endDate = new Date(dateRange.end);
                    endDate.setDate(endDate.getDate() + 1);
                    query = query.lt('created_at', endDate.toISOString().split('T')[0]);
                }
                
                const { data, error } = await query.order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('Loaded assets:', data);
                allAssets = data || [];
                renderAssets();
                updateNetWorth();
                
            } catch (error) {
                console.error('Error loading assets:', error);
            }
        }
        
        // ============================================
        // Load Liabilities
        // ============================================
        
        async function loadLiabilities() {
            try {
                // Get date range from quick filter
                const dateRange = getBalanceSheetDateRange();
                
                let query = supabase
                    .from('liabilities')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                // Apply date filter if not "All Time"
                if (dateRange.start) {
                    query = query.gte('created_at', dateRange.start);
                }
                if (dateRange.end) {
                    // Add one day to include items created on end date
                    const endDate = new Date(dateRange.end);
                    endDate.setDate(endDate.getDate() + 1);
                    query = query.lt('created_at', endDate.toISOString().split('T')[0]);
                }
                
                const { data, error } = await query.order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('Loaded liabilities:', data);
                allLiabilities = data || [];
                renderLiabilities();
                updateNetWorth();
                
            } catch (error) {
                console.error('Error loading liabilities:', error);
            }
        }
        
        // ============================================
        // Render Assets
        // ============================================
        
        function renderAssets(assets, totalAssets) {
            // Update global variable for legacy compatibility
            allAssets = assets || [];
            
            // Hide loading skeleton
            document.getElementById('total-assets-summary-loading')?.classList.add('hidden');
            
            // Update and show summary
            const summaryEl = document.getElementById('total-assets-summary');
            if (summaryEl) {
                summaryEl.textContent = formatCurrencyDisplay(totalAssets);
                summaryEl.classList.remove('hidden');
            }
            
            // Render list
            const container = document.getElementById('assets-list');
            const emptyState = document.getElementById('assets-empty');
            
            if (allAssets.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            container.innerHTML = allAssets.map(asset => `
                <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                ${getAssetIcon(asset.asset_type)}
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">${asset.asset_name}</h3>
                                <p class="text-sm text-gray-600">${getAssetTypeLabel(asset.asset_type)}</p>
                            </div>
                        </div>
                        <button onclick="deleteAsset('${asset.id}')" class="text-gray-400 hover:text-red-600 transition-colors" title="Delete">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-2xl font-bold text-accent">${formatCurrencyDisplay(asset.current_value)}</p>
                            ${asset.purchase_date ? `<p class="text-xs text-gray-500 mt-1">Purchased: ${formatDate(asset.purchase_date)}</p>` : ''}
                        </div>
                    </div>
                    ${asset.notes ? `<p class="text-sm text-gray-600 mt-3 pt-3 border-t border-gray-200">${asset.notes}</p>` : ''}
                </div>
            `).join('');
        }
        
        // ============================================
        // Render Liabilities
        // ============================================
        
        function renderLiabilities(liabilities, totalLiabilities) {
            // Update global variable for legacy compatibility
            allLiabilities = liabilities || [];
            
            // Hide loading skeleton
            document.getElementById('total-liabilities-summary-loading')?.classList.add('hidden');
            
            // Update and show summary
            const summaryEl = document.getElementById('total-liabilities-summary');
            if (summaryEl) {
                summaryEl.textContent = formatCurrencyDisplay(totalLiabilities);
                summaryEl.classList.remove('hidden');
            }
            
            // Render list
            const container = document.getElementById('liabilities-list');
            const emptyState = document.getElementById('liabilities-empty');
            
            if (allLiabilities.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            container.innerHTML = allLiabilities.map(liability => `
                <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                                ${getLiabilityIcon(liability.liability_type)}
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">${liability.liability_name}</h3>
                                <p class="text-sm text-gray-600">${getLiabilityTypeLabel(liability.liability_type)}</p>
                            </div>
                        </div>
                        <button onclick="deleteLiability('${liability.id}')" class="text-gray-400 hover:text-red-600 transition-colors" title="Delete">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-2xl font-bold text-danger">${formatCurrencyDisplay(liability.current_balance)}</p>
                            ${liability.due_date ? `<p class="text-xs text-gray-500 mt-1">Due: ${formatDate(liability.due_date)}</p>` : ''}
                        </div>
                    </div>
                    ${liability.notes ? `<p class="text-sm text-gray-600 mb-3 pb-3 border-b border-gray-200">${liability.notes}</p>` : ''}
                    
                    <!-- Make Payment Button -->
                    <button 
                        onclick="openPaymentModal('${liability.id}', '${liability.liability_name}', ${liability.current_balance})"
                        class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200 shadow-sm hover:shadow-md"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Make Payment
                    </button>
                </div>
            `).join('');
        }
        
        // ============================================
        // Update Net Worth
        // ============================================
        
        function updateNetWorth(netWorth, totalAssets, totalLiabilities) {
            // If no parameters provided, calculate from global variables (legacy compatibility)
            if (netWorth === undefined) {
                totalAssets = allAssets.reduce((sum, asset) => sum + parseFloat(asset.current_value), 0);
                totalLiabilities = allLiabilities.reduce((sum, liability) => sum + parseFloat(liability.current_balance), 0);
                netWorth = totalAssets - totalLiabilities;
            }
            
            // Hide loading skeleton
            const netWorthLoading = document.getElementById('net-worth-loading');
            if (netWorthLoading) netWorthLoading.classList.add('hidden');
            
            // Show and update net worth card
            const netWorthEl = document.getElementById('net-worth');
            if (netWorthEl) {
                netWorthEl.textContent = formatCurrencyDisplay(netWorth);
                netWorthEl.classList.remove('hidden');
            }
            
            document.getElementById('net-worth-formula').textContent = 
                `${formatCurrencyDisplay(totalAssets)} - ${formatCurrencyDisplay(totalLiabilities)} = ${formatCurrencyDisplay(netWorth)}`;
        }
        
        // ============================================
        // Asset Modal Functions
        // ============================================
        
        const assetModal = document.getElementById('asset-modal');
        const assetForm = document.getElementById('asset-form');
        
        function openAssetModal() {
            assetModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeAssetModal() {
            assetModal.classList.add('hidden');
            assetForm.reset();
            document.getElementById('asset-error').classList.add('hidden');
            document.getElementById('asset-success').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // ============================================
        // Liability Modal Functions
        // ============================================
        
        const liabilityModal = document.getElementById('liability-modal');
        const liabilityForm = document.getElementById('liability-form');
        
        function openLiabilityModal() {
            liabilityModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            populateLinkedAssets();
        }
        
        function closeLiabilityModal() {
            liabilityModal.classList.add('hidden');
            liabilityForm.reset();
            document.getElementById('liability-error').classList.add('hidden');
            document.getElementById('liability-success').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // ============================================
        // Owner's Equity Modal Functions
        // ============================================
        
        const equityModal = document.getElementById('equity-modal');
        const equityForm = document.getElementById('equity-form');
        
        function openEquityModal(transactionType) {
            // Set transaction type
            document.getElementById('equity-transaction-type').value = transactionType;
            
            // Update modal title and info based on type
            const titleEl = document.getElementById('equity-modal-title');
            const infoTitleEl = document.getElementById('equity-info-title');
            const infoTextEl = document.getElementById('equity-info-text');
            const submitTextEl = document.getElementById('equity-submit-text');
            const submitBtn = document.getElementById('equity-submit-btn');
            const infoBanner = document.getElementById('equity-info-banner');
            
            if (transactionType === 'contribution') {
                titleEl.textContent = 'Add Contribution';
                infoTitleEl.textContent = 'About Contributions';
                infoTextEl.textContent = 'Record money you invest into your business. This increases your owner\'s equity but doesn\'t affect your profit/loss.';
                submitTextEl.textContent = 'Record Contribution';
                infoBanner.className = 'bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 mb-5';
                infoTitleEl.className = 'text-sm font-semibold text-blue-900 mb-1';
                infoTextEl.className = 'text-xs text-blue-800';
                submitBtn.className = 'flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2';
            } else {
                titleEl.textContent = 'Record Draw';
                infoTitleEl.textContent = 'About Draws';
                infoTextEl.textContent = 'Record money you take out for personal use. This decreases your owner\'s equity but doesn\'t affect your profit/loss.';
                submitTextEl.textContent = 'Record Draw';
                infoBanner.className = 'bg-orange-50 border border-orange-200 rounded-lg px-4 py-3 mb-5';
                infoTitleEl.className = 'text-sm font-semibold text-orange-900 mb-1';
                infoTextEl.className = 'text-xs text-orange-800';
                submitBtn.className = 'flex-1 px-4 py-3 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition-colors flex items-center justify-center gap-2';
            }
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('equity-date').value = today;
            
            // Show modal
            equityModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeEquityModal() {
            equityModal.classList.add('hidden');
            equityForm.reset();
            document.getElementById('equity-error').classList.add('hidden');
            document.getElementById('equity-success').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // Format currency in equity amount field
        function formatEquityCurrency(input) {
            let value = input.value.replace(/[^0-9.]/g, '');
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            if (parts[1] && parts[1].length > 2) {
                value = parts[0] + '.' + parts[1].substring(0, 2);
            }
            input.value = value;
        }
        
        // Handle equity form submission
        equityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('equity-submit-btn');
            const errorDiv = document.getElementById('equity-error');
            const errorMessage = document.getElementById('equity-error-message');
            const successDiv = document.getElementById('equity-success');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';
            
            try {
                const amount = parseFloat(document.getElementById('equity-amount').value);
                
                // Validation
                if (isNaN(amount) || amount <= 0) {
                    throw new Error('Please enter a valid amount');
                }
                
                // Insert into owner_equity table
                const { data, error } = await supabase
                    .from('owner_equity')
                    .insert([{
                        user_id: currentUser.id,
                        transaction_date: document.getElementById('equity-date').value,
                        transaction_type: document.getElementById('equity-transaction-type').value,
                        amount: amount,
                        description: document.getElementById('equity-description').value,
                        notes: document.getElementById('equity-notes').value || null
                    }])
                    .select();
                
                if (error) throw error;
                
                console.log('Equity transaction recorded:', data);
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Record Transaction';
                
                // Trigger confetti FIRST!
                celebrateMoneyRain();
                
                // Then close modal after short delay
                setTimeout(() => {
                    closeEquityModal();
                }, 300);
                
                // Reload data in background
                loadOwnerEquity();
                updateNetWorth();
                
            } catch (error) {
                console.error('Error recording equity transaction:', error);
                errorMessage.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> <span id="equity-submit-text">Record Transaction</span>';
            }
        });
        
        // ============================================
        // Load Owner's Equity
        // ============================================
        
        async function loadOwnerEquity() {
            if (!currentUser) return;
            
            try {
                // Get date range from quick filter
                const dateRange = getBalanceSheetDateRange();
                
                let query = supabase
                    .from('owner_equity')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                // Apply date filter if not "All Time"
                if (dateRange.start) {
                    query = query.gte('transaction_date', dateRange.start);
                }
                if (dateRange.end) {
                    query = query.lte('transaction_date', dateRange.end);
                }
                
                const { data, error } = await query.order('transaction_date', { ascending: false });
                
                if (error) throw error;
                
                // Calculate totals
                const contributions = data.filter(t => t.transaction_type === 'contribution');
                const draws = data.filter(t => t.transaction_type === 'draw');
                
                const totalContributions = contributions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalDraws = draws.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const netEquity = totalContributions - totalDraws;
                
                // Hide loading skeletons
                document.getElementById('total-contributions-loading')?.classList.add('hidden');
                document.getElementById('total-draws-loading')?.classList.add('hidden');
                document.getElementById('net-equity-loading')?.classList.add('hidden');
                
                // Update and show summary cards
                const contributionsEl = document.getElementById('total-contributions');
                const drawsEl = document.getElementById('total-draws');
                const netEquityEl = document.getElementById('net-equity');
                
                if (contributionsEl) {
                    contributionsEl.textContent = formatCurrencyDisplay(totalContributions);
                    contributionsEl.classList.remove('hidden');
                }
                if (drawsEl) {
                    drawsEl.textContent = formatCurrencyDisplay(totalDraws);
                    drawsEl.classList.remove('hidden');
                }
                if (netEquityEl) {
                    netEquityEl.textContent = formatCurrencyDisplay(netEquity);
                    netEquityEl.classList.remove('hidden');
                }
                
                // Render transactions list
                renderEquityList(data);
                
            } catch (error) {
                console.error('Error loading owner equity:', error);
            }
        }
        
        // ============================================
        // Load Balance Sheet AI Insight
        // ============================================
        
        async function loadBalanceSheetInsight(data) {
            try {
                const insight = await generateAIInsight('balanceSheet', data);
                displayInsight('ai-insight-container', insight, false);
            } catch (error) {
                console.error('Error loading Balance Sheet insight:', error);
                displayInsight('ai-insight-container', 'Unable to generate insight at this time. Please try again later.', false);
            }
        }
        
        function refreshInsight() {
            clearInsightCache('balanceSheet');
            loadAssets();
            loadLiabilities();
            loadOwnerEquity();
        }
        
        function renderOwnerEquity(transactions, totalContributions, totalDraws, netEquity) {
            // Hide loading skeletons
            document.getElementById('total-contributions-loading')?.classList.add('hidden');
            document.getElementById('total-draws-loading')?.classList.add('hidden');
            document.getElementById('net-equity-loading')?.classList.add('hidden');
            
            // Update and show summary cards
            const contributionsEl = document.getElementById('total-contributions');
            const drawsEl = document.getElementById('total-draws');
            const netEquityEl = document.getElementById('net-equity');
            
            if (contributionsEl) {
                contributionsEl.textContent = formatCurrencyDisplay(totalContributions);
                contributionsEl.classList.remove('hidden');
            }
            if (drawsEl) {
                drawsEl.textContent = formatCurrencyDisplay(totalDraws);
                drawsEl.classList.remove('hidden');
            }
            if (netEquityEl) {
                netEquityEl.textContent = formatCurrencyDisplay(netEquity);
                netEquityEl.classList.remove('hidden');
            }
            
            // Render transactions list
            renderEquityList(transactions);
        }
        
        function renderEquityList(transactions) {
            const listEl = document.getElementById('equity-list');
            const emptyEl = document.getElementById('equity-empty');
            
            if (transactions.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }
            
            emptyEl.classList.add('hidden');
            
            listEl.innerHTML = transactions.map(transaction => {
                const isContribution = transaction.transaction_type === 'contribution';
                const iconBg = isContribution ? 'bg-blue-50' : 'bg-orange-50';
                const iconColor = isContribution ? 'text-blue-600' : 'text-orange-600';
                const amountColor = isContribution ? 'text-blue-600' : 'text-orange-600';
                const typeLabel = isContribution ? 'Contribution' : 'Draw';
                const typeBadgeBg = isContribution ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700';
                const borderAccent = isContribution ? 'border-l-4 border-blue-500' : 'border-l-4 border-orange-500';
                const icon = isContribution 
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>'
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>';
                
                return `
                    <div class="bg-white border border-gray-200 ${borderAccent} rounded-lg p-4 hover:shadow-md transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-10 h-10 ${iconBg} rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        ${icon}
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-sm font-semibold text-gray-900">${transaction.description}</span>
                                        <span class="text-xs px-2 py-0.5 ${typeBadgeBg} rounded font-medium">${typeLabel}</span>
                                    </div>
                                    <p class="text-xs text-slate-600">${formatDate(transaction.transaction_date)}</p>
                                    ${transaction.notes ? `<p class="text-xs text-slate-500 mt-1">${transaction.notes}</p>` : ''}
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <p class="text-xl font-bold ${amountColor}">${formatCurrencyDisplay(transaction.amount)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ============================================
        // Payment Modal Functions
        // ============================================
        
        let currentLiabilityForPayment = null;
        
        function openPaymentModal(liabilityId, liabilityName, currentBalance) {
            currentLiabilityForPayment = liabilityId;
            
            // Set liability info
            document.getElementById('payment-liability-name').textContent = liabilityName;
            document.getElementById('payment-current-balance').textContent = formatCurrencyDisplay(currentBalance);
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            // Show modal
            document.getElementById('payment-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            document.getElementById('payment-form').reset();
            document.getElementById('payment-error').classList.add('hidden');
            document.getElementById('payment-success').classList.add('hidden');
            document.getElementById('payment-principal-display').textContent = '$0.00';
            document.body.style.overflow = 'auto';
            currentLiabilityForPayment = null;
        }
        
        // Format currency in payment fields
        function formatPaymentCurrency(input) {
            let value = input.value.replace(/[^0-9.]/g, '');
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            if (parts[1] && parts[1].length > 2) {
                value = parts[0] + '.' + parts[1].substring(0, 2);
            }
            input.value = value;
        }
        
        // Calculate principal amount automatically
        function calculatePrincipal() {
            const totalInput = document.getElementById('payment-total').value;
            const interestInput = document.getElementById('payment-interest').value;
            
            const total = parseFloat(totalInput) || 0;
            const interest = parseFloat(interestInput) || 0;
            const principal = total - interest;
            
            const principalDisplay = document.getElementById('payment-principal-display');
            if (principal >= 0) {
                principalDisplay.textContent = formatCurrencyDisplay(principal);
                principalDisplay.classList.remove('text-red-800');
                principalDisplay.classList.add('text-green-800');
            } else {
                principalDisplay.textContent = formatCurrencyDisplay(principal);
                principalDisplay.classList.remove('text-green-800');
                principalDisplay.classList.add('text-red-800');
            }
        }
        
        // Handle payment form submission
        const paymentForm = document.getElementById('payment-form');
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('payment-submit-btn');
            const errorDiv = document.getElementById('payment-error');
            const errorMessage = document.getElementById('payment-error-message');
            const successDiv = document.getElementById('payment-success');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';
            
            try {
                const totalPayment = parseFloat(document.getElementById('payment-total').value);
                const interestAmount = parseFloat(document.getElementById('payment-interest').value);
                const principalAmount = totalPayment - interestAmount;
                
                // Validation
                if (isNaN(totalPayment) || totalPayment <= 0) {
                    throw new Error('Please enter a valid total payment amount');
                }
                if (isNaN(interestAmount) || interestAmount < 0) {
                    throw new Error('Please enter a valid interest amount');
                }
                if (principalAmount < 0) {
                    throw new Error('Interest amount cannot exceed total payment');
                }
                
                // Step 1: Create interest expense entry (if interest > 0)
                let expenseId = null;
                if (interestAmount > 0) {
                    const { data: expenseData, error: expenseError } = await supabase
                        .from('expenses')
                        .insert([{
                            user_id: currentUser.id,
                            date: document.getElementById('payment-date').value,
                            category: 'Interest Expense',
                            amount: interestAmount,
                            description: `Interest payment for ${document.getElementById('payment-liability-name').textContent}`
                        }])
                        .select();
                    
                    if (expenseError) throw expenseError;
                    expenseId = expenseData[0].id;
                }
                
                // Step 2: Record the loan payment
                const { data: paymentData, error: paymentError } = await supabase
                    .from('loan_payments')
                    .insert([{
                        user_id: currentUser.id,
                        liability_id: currentLiabilityForPayment,
                        payment_date: document.getElementById('payment-date').value,
                        total_payment: totalPayment,
                        principal_amount: principalAmount,
                        interest_amount: interestAmount,
                        notes: document.getElementById('payment-notes').value || null,
                        expense_id: expenseId
                    }])
                    .select();
                
                if (paymentError) throw paymentError;
                
                console.log('Payment recorded:', paymentData);
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Record Payment';
                
                // Trigger confetti FIRST!
                celebrateSuccess();
                
                // Then close modal after short delay
                setTimeout(() => {
                    closePaymentModal();
                }, 300);
                
                // Reload data in background
                loadLiabilities();
                
            } catch (error) {
                console.error('Error recording payment:', error);
                errorMessage.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Record Payment';
            }
        });
        
        // ============================================
        // Add Asset Form Handler
        // ============================================
        
        assetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('asset-submit-btn');
            const errorDiv = document.getElementById('asset-error');
            const errorMsg = document.getElementById('asset-error-message');
            const successDiv = document.getElementById('asset-success');
            
            // Hide previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Adding...';
            
            try {
                const valueInput = unformatCurrency(document.getElementById('asset-value'));
                const value = parseFloat(valueInput);
                const assetName = document.getElementById('asset-name').value;
                
                // Add the asset
                const { data: assetData, error: assetError } = await supabase
                    .from('assets')
                    .insert([
                        {
                            user_id: currentUser.id,
                            asset_name: assetName,
                            asset_type: document.getElementById('asset-type').value,
                            current_value: value,
                            purchase_date: document.getElementById('asset-purchase-date').value || null,
                            purchase_price: document.getElementById('asset-purchase-price').value ? parseFloat(unformatCurrency(document.getElementById('asset-purchase-price'))) : null,
                            track_depreciation: document.getElementById('track-depreciation')?.checked || false,
                            notes: document.getElementById('asset-notes').value || null
                        }
                    ])
                    .select();
                
                if (assetError) throw assetError;
                
                console.log('Asset added:', assetData);
                
                // Check if user wants to add a loan for this asset
                const hasLoan = document.getElementById('has-loan')?.checked;
                if (hasLoan) {
                    const loanBalance = document.getElementById('loan-balance')?.value;
                    const loanLender = document.getElementById('loan-lender')?.value;
                    
                    if (loanBalance && parseFloat(unformatCurrency(document.getElementById('loan-balance'))) > 0) {
                        // Add the liability
                        const liabilityName = `${assetName} Loan`;
                        const loanBalanceValue = parseFloat(unformatCurrency(document.getElementById('loan-balance')));
                        const interestRate = document.getElementById('loan-interest-rate')?.value ? parseFloat(document.getElementById('loan-interest-rate').value) : null;
                        const monthlyPayment = document.getElementById('loan-monthly-payment')?.value ? parseFloat(unformatCurrency(document.getElementById('loan-monthly-payment'))) : null;
                        const loanNotes = document.getElementById('loan-notes')?.value || null;
                        
                        // Build notes
                        let fullNotes = loanNotes || '';
                        if (loanLender) {
                            fullNotes = `Lender: ${loanLender}${fullNotes ? '\n' + fullNotes : ''}`;
                        }
                        fullNotes = `Loan for: ${assetName}${fullNotes ? '\n' + fullNotes : ''}`;
                        
                        const { data: liabilityData, error: liabilityError } = await supabase
                            .from('liabilities')
                            .insert([
                                {
                                    user_id: currentUser.id,
                                    liability_name: liabilityName,
                                    liability_type: 'auto_loan',
                                    current_balance: loanBalanceValue,
                                    interest_rate: interestRate,
                                    monthly_payment: monthlyPayment,
                                    notes: fullNotes
                                }
                            ])
                            .select();
                        
                        if (liabilityError) {
                            console.error('Error adding liability:', liabilityError);
                            // Don't throw - asset was added successfully
                            errorMsg.textContent = 'Asset added, but there was an error adding the loan. You can add it manually from "What You Owe".';
                            errorDiv.classList.remove('hidden');
                        } else {
                            console.log('Liability added:', liabilityData);
                        }
                    }
                }
                
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Asset';
                
                // Trigger confetti FIRST!
                celebrateMoneyRain();
                
                // Then close modal after short delay
                setTimeout(() => {
                    closeAssetModal();
                }, 300);
                
                // Reload data in background
                loadAssets();
                loadLiabilities();
                
            } catch (error) {
                console.error('Error adding asset:', error);
                errorMsg.textContent = error.message || 'Failed to add asset. Please try again.';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Asset';
            }
        });
        
        // ============================================
        // Add Liability Form Handler
        // ============================================
        
        liabilityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('liability-submit-btn');
            const errorDiv = document.getElementById('liability-error');
            const errorMsg = document.getElementById('liability-error-message');
            const successDiv = document.getElementById('liability-success');
            
            // Hide previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Adding...';
            
            try {
                const balanceInput = unformatCurrency(document.getElementById('liability-balance'));
                const balance = parseFloat(balanceInput);
                
                const { data, error } = await supabase
                    .from('liabilities')
                    .insert([
                        {
                            user_id: currentUser.id,
                            liability_name: document.getElementById('liability-name').value,
                            liability_type: document.getElementById('liability-type').value,
                            current_balance: balance,
                            due_date: document.getElementById('liability-due-date').value || null,
                            notes: document.getElementById('liability-notes').value || null
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                console.log('Liability added:', data);
                
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Liability';
                
                // Trigger confetti FIRST!
                celebrateSuccess();
                
                // Then close modal after short delay
                setTimeout(() => {
                    closeLiabilityModal();
                }, 300);
                
                // Reload data in background
                loadLiabilities();
                
            } catch (error) {
                console.error('Error adding liability:', error);
                errorMsg.textContent = error.message || 'Failed to add liability. Please try again.';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Liability';
            }
        });
        
        // ============================================
        // Delete Functions
        // ============================================
        
        async function deleteAsset(id) {
            if (!confirm('Are you sure you want to delete this asset?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('assets')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                console.log('Asset deleted:', id);
                await loadAssets();
                
            } catch (error) {
                console.error('Error deleting asset:', error);
                alert('Failed to delete asset. Please try again.');
            }
        }
        
        async function deleteLiability(id) {
            if (!confirm('Are you sure you want to delete this liability?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('liabilities')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                console.log('Liability deleted:', id);
                await loadLiabilities();
                
            } catch (error) {
                console.error('Error deleting liability:', error);
                alert('Failed to delete liability. Please try again.');
            }
        }
        
        // ============================================
        // Tooltip Functions
        // ============================================
        
        function showTooltip(id) {
            const tooltip = document.getElementById(id);
            if (tooltip) {
                tooltip.classList.remove('hidden');
            }
        }
        
        function hideTooltip(id) {
            const tooltip = document.getElementById(id);
            if (tooltip) {
                tooltip.classList.add('hidden');
            }
        }
        
        // ============================================
        // Smart Form Functions
        // ============================================
        
        // Auto-suggest asset type based on name
        function autoSuggestAssetType() {
            const assetName = document.getElementById('asset-name').value.toLowerCase();
            const assetType = document.getElementById('asset-type');
            
            // Vehicle keywords
            const vehicleKeywords = ['escalade', 'suburban', 'tahoe', 'yukon', 'navigator', 'expedition', 'car', 'suv', 'sedan', 'truck', 'van', 'vehicle'];
            // Equipment keywords
            const equipmentKeywords = ['iphone', 'ipad', 'tablet', 'phone', 'dashcam', 'camera', 'charger', 'mount', 'gps'];
            // Cash keywords
            const cashKeywords = ['bank', 'account', 'checking', 'savings', 'chase', 'wells', 'bofa'];
            
            if (vehicleKeywords.some(keyword => assetName.includes(keyword))) {
                assetType.value = 'vehicle';
                updateAssetTypeDescription();
            } else if (equipmentKeywords.some(keyword => assetName.includes(keyword))) {
                assetType.value = 'equipment';
                updateAssetTypeDescription();
            } else if (cashKeywords.some(keyword => assetName.includes(keyword))) {
                assetType.value = 'cash';
                updateAssetTypeDescription();
            }
        }
        
        // Update asset type description
        function updateAssetTypeDescription() {
            const select = document.getElementById('asset-type');
            const description = document.getElementById('asset-type-description');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.desc) {
                description.textContent = selectedOption.dataset.desc;
                description.classList.remove('hidden');
            } else {
                description.classList.add('hidden');
            }
        }
        
        // Update liability type description
        function updateLiabilityTypeDescription() {
            const select = document.getElementById('liability-type');
            const description = document.getElementById('liability-type-description');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.desc) {
                description.textContent = selectedOption.dataset.desc;
                description.classList.remove('hidden');
            } else {
                description.classList.add('hidden');
            }
            
            // Populate linked assets dropdown when opening liability modal
            populateLinkedAssets();
        }
        
        // Populate linked assets dropdown
        function populateLinkedAssets() {
            const linkedAssetSelect = document.getElementById('linked-asset');
            if (!linkedAssetSelect) return;
            
            // Clear existing options except first
            linkedAssetSelect.innerHTML = '<option value="">Not linked to any asset</option>';
            
            // Add vehicle assets
            const vehicleAssets = allAssets.filter(asset => asset.asset_type === 'vehicle');
            vehicleAssets.forEach(asset => {
                const option = document.createElement('option');
                option.value = asset.id;
                option.textContent = asset.asset_name;
                linkedAssetSelect.appendChild(option);
            });
        }
        
        // Toggle loan fields
        function toggleLoanFields() {
            const hasLoan = document.getElementById('has-loan');
            const loanFields = document.getElementById('loan-fields');
            
            if (hasLoan && loanFields) {
                if (hasLoan.checked) {
                    loanFields.classList.remove('hidden');
                } else {
                    loanFields.classList.add('hidden');
                }
            }
        }
        
        // Toggle depreciation fields
        document.addEventListener('DOMContentLoaded', function() {
            const depreciationCheckbox = document.getElementById('track-depreciation');
            const depreciationFields = document.getElementById('depreciation-fields');
            
            if (depreciationCheckbox && depreciationFields) {
                depreciationCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        depreciationFields.classList.remove('hidden');
                    } else {
                        depreciationFields.classList.add('hidden');
                    }
                });
            }
        });
        
        // Open calculator (placeholder function)
        function openCalculator(type) {
            // Simple alert for now - can be enhanced with a modal calculator
            alert('Calculator feature coming soon! For now, you can use your phone\'s calculator app and enter the result here.');
        }
        
        // ============================================
        // Helper Functions
        // ============================================
        
        function getAssetIcon(type) {
            const icons = {
                'vehicle': '<svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>',
                'equipment': '<svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>',
                'cash': '<svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>',
                'receivable': '<svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
                'other': '<svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>'
            };
            return icons[type] || icons['other'];
        }
        
        function getLiabilityIcon(type) {
            const icons = {
                'auto_loan': '<svg class="w-6 h-6 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>',
                'lease': '<svg class="w-6 h-6 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
                'credit_card': '<svg class="w-6 h-6 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>',
                'tax': '<svg class="w-6 h-6 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>',
                'other': '<svg class="w-6 h-6 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"></path></svg>'
            };
            return icons[type] || icons['other'];
        }
        
        function getAssetTypeLabel(type) {
            const labels = {
                'vehicle': 'Fleet Vehicle',
                'equipment': 'Equipment & Accessories',
                'cash': 'Business Bank Account',
                'receivable': 'Unpaid Client Invoices',
                'other': 'Other Asset'
            };
            return labels[type] || 'Other Asset';
        }
        
        function getLiabilityTypeLabel(type) {
            const labels = {
                'auto_loan': 'Auto Loan',
                'lease': 'Vehicle Lease',
                'credit_card': 'Credit Card Balance',
                'tax': 'Tax Payable',
                'other': 'Other Debt'
            };
            return labels[type] || 'Other Debt';
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }
        
        function formatCurrencyDisplay(number) {
            if (number === null || number === undefined || isNaN(number)) {
                return '$0.00';
            }
            return '$' + parseFloat(number).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // ============================================
        // Animated Number Counter
        // ============================================
        
        function animateNumber(element, targetValue, duration = 1000, prefix = '$', decimals = 2) {
            if (!element) return;
            
            const startValue = 0;
            const startTime = performance.now();
            
            // Easing function for smooth animation
            function easeOutQuart(x) {
                return 1 - Math.pow(1 - x, 4);
            }
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Apply easing
                const easedProgress = easeOutQuart(progress);
                const currentValue = startValue + (targetValue - startValue) * easedProgress;
                
                // Format the number
                const formattedValue = currentValue.toLocaleString('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
                
                element.textContent = prefix + formattedValue;
                
                // Continue animation if not complete
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }
        
        // Helper function to animate currency values
        function animateCurrency(elementId, value) {
            const element = document.getElementById(elementId);
            if (element && value !== null && value !== undefined && !isNaN(value)) {
                animateNumber(element, parseFloat(value), 1000, '$', 2);
            }
        }
        
        function formatCurrency(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (!value) {
                input.value = '';
                return;
            }
            let number = parseInt(value);
            let formatted = number.toLocaleString('en-US');
            input.value = formatted;
        }
        
        function unformatCurrency(input) {
            return input.value.replace(/,/g, '');
        }
        
        // ============================================
        // Initialize
        // ============================================
        
        checkAuth();
    </script>
</body>
</html>

