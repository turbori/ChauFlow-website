<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | ChauFlow</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        accent: '#10B981',
                        danger: '#EF4444',
                        background: '#F9FAFB',
                        textDark: '#1F2937'
                    }
                }
            }
        }
    </script>
    
    <!-- Mobile Optimizations CSS -->
    <link rel="stylesheet" href="mobile-optimizations.css">
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="confetti-celebration.js"></script>
    
    <!-- Configuration (API Keys) -->
    <script src="config.js"></script>
    <script src="ai-insights.js"></script>
    
    <!-- Skeleton Loader Styles -->
    <style>
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
            border-radius: 0.5rem;
        }
        
        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .skeleton-title {
            height: 1.5rem;
            width: 60%;
            margin-bottom: 1rem;
        }
        
        .skeleton-card {
            height: 150px;
        }
        
        /* Number counting animation */
        .counting-number {
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        /* Recent Activity Animations */
        .activity-item {
            animation: slideIn 0.4s ease-out;
            transition: all 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Smooth height transitions for activity list */
        #recent-activity {
            transition: all 0.3s ease;
        }
        
        /* Stagger animation for multiple items */
        .activity-item:nth-child(1) { animation-delay: 0s; }
        .activity-item:nth-child(2) { animation-delay: 0.05s; }
        .activity-item:nth-child(3) { animation-delay: 0.1s; }
        .activity-item:nth-child(4) { animation-delay: 0.15s; }
        .activity-item:nth-child(5) { animation-delay: 0.2s; }
        .activity-item:nth-child(6) { animation-delay: 0.25s; }
        .activity-item:nth-child(7) { animation-delay: 0.3s; }
        .activity-item:nth-child(8) { animation-delay: 0.35s; }
        .activity-item:nth-child(9) { animation-delay: 0.4s; }
        .activity-item:nth-child(10) { animation-delay: 0.45s; }
    </style>
    
    <!-- Global Date Filter Scripts -->
    <script src="global-date-filter.js"></script>
    <script src="global-filter-ui.js"></script>
</head>
<body class="bg-background min-h-screen">
    
    <!-- Navigation Header -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center gap-8">
                    <h1 class="text-xl md:text-2xl font-bold text-primary">ChauFlow</h1>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden md:flex items-center space-x-6">
                        <a href="dashboard.html" class="text-primary font-medium border-b-2 border-primary pb-1">Dashboard</a>
                        <a href="income.html" class="text-gray-600 hover:text-primary transition-colors duration-200">Income</a>
                        <a href="expenses.html" class="text-gray-600 hover:text-primary transition-colors duration-200">Expenses</a>
                        <a href="balance-sheet.html" class="text-gray-600 hover:text-primary transition-colors duration-200">Balance Sheet</a>
                    </div>
                </div>
                
                <!-- User Menu & Mobile Menu Button -->
                <div class="flex items-center gap-3">
                    <div class="hidden md:block text-right">
                        <p class="text-xs text-gray-500 mb-0.5">Logged in as</p>
                        <p class="text-sm font-medium text-gray-800" id="user-email">Loading...</p>
                    </div>
                    <div class="relative hidden md:block">
                        <button 
                            id="user-menu-btn"
                            class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 hover:shadow-md transition-all duration-200 font-medium"
                            onclick="toggleUserMenu()"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="user-menu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-50">
                            <div class="px-4 py-2 border-b border-gray-100">
                                <p class="text-xs text-gray-500">Signed in as</p>
                                <p class="text-sm font-semibold text-gray-800 truncate" id="user-email-menu">Loading...</p>
                            </div>
                            <a href="dashboard.html" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                </svg>
                                Dashboard
                            </a>
                            <a href="income.html" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Income
                            </a>
                            <a href="expenses.html" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                </svg>
                                Expenses
                            </a>
                            <a href="balance-sheet.html" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                Balance Sheet
                            </a>
                            <button class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 opacity-50 cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Settings
                                <span class="ml-auto text-xs text-gray-400">Soon</span>
                            </button>
                            <div class="border-t border-gray-100 mt-1 pt-1">
                    <button 
                        id="signout-btn"
                                    class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 font-medium"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Navigation Menu -->
            <div id="mobile-nav-menu" class="hidden md:hidden border-t border-gray-200 bg-white">
                <div class="px-4 py-4 space-y-2">
                    <!-- User Info -->
                    <div class="px-4 py-3 bg-gray-50 rounded-lg mb-2">
                        <p class="text-xs text-gray-500 mb-0.5">Logged in as</p>
                        <p class="text-sm font-medium text-gray-800" id="mobile-user-email">Loading...</p>
                    </div>
                    
                    <!-- Navigation Links -->
                    <a href="dashboard.html" class="block px-4 py-3 text-primary bg-blue-50 rounded-lg font-medium">Dashboard</a>
                    <a href="income.html" class="block px-4 py-3 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-lg transition-colors duration-200">Income</a>
                    <a href="expenses.html" class="block px-4 py-3 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-lg transition-colors duration-200">Expenses</a>
                    <a href="balance-sheet.html" class="block px-4 py-3 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-lg transition-colors duration-200">Balance Sheet</a>
                    
                    <!-- Sign Out Button -->
                    <button id="mobile-signout-btn" class="w-full text-left px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200 font-medium flex items-center gap-2 border-t border-gray-200 mt-2 pt-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 safe-area-bottom shadow-lg">
        <div class="grid grid-cols-4 h-16">
            <a href="dashboard.html" class="flex flex-col items-center justify-center text-primary bg-blue-50">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs font-semibold">Home</span>
            </a>
            <a href="income.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-xs font-medium">Income</span>
            </a>
            <a href="expenses.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <span class="text-xs font-medium">Expenses</span>
            </a>
            <a href="balance-sheet.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-primary hover:bg-gray-50 transition-colors">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <span class="text-xs font-medium">Balance Sheet</span>
            </a>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 md:py-8 pb-20 md:pb-8">
        
        <!-- Welcome Section -->
        <div class="mb-4 md:mb-8">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Welcome back!</h2>
            <p class="text-base md:text-lg text-gray-600">Here's your bookkeeping overview</p>
        </div>
        
        <!-- Quick Filters -->
        <div class="bg-white rounded-xl md:rounded-2xl p-4 md:p-6 shadow-sm border border-gray-200 mb-4 md:mb-6">
            <label for="dashboard-filter-select" class="block text-sm md:text-sm font-semibold text-gray-700 mb-3">Time Period</label>
            <select id="dashboard-filter-select" onchange="applyDashboardQuickFilter(this.value)" class="w-full md:w-64 px-4 py-3.5 text-base border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary text-gray-900 font-medium shadow-sm">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="thisMonth" selected>This Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="last30Days">Last 30 Days</option>
                <option value="last90Days">Last 90 Days</option>
                <option value="thisYear">This Year</option>
                <option value="lastYear">Last Year</option>
                <option value="allTime">All Time</option>
            </select>
        </div>
        
        <!-- Skeleton Loaders for Stats Cards -->
        <div id="stats-skeleton" class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                <div class="skeleton skeleton-card"></div>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                <div class="skeleton skeleton-card"></div>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                <div class="skeleton skeleton-card"></div>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div id="stats-cards" class="hidden grid grid-cols-3 gap-2 md:gap-6 mb-6 md:mb-8">
            <!-- Card 1: Total Income -->
            <div class="bg-white rounded-lg md:rounded-2xl p-3 md:p-6 shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 group relative">
                <div class="flex flex-col md:flex-row items-start md:justify-between mb-2 md:mb-4">
                    <div class="w-8 h-8 md:w-12 md:h-12 bg-green-100 rounded-lg md:rounded-xl flex items-center justify-center mb-2 md:mb-0">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <button class="group/tooltip relative" onmouseenter="showTooltip('income-tip')" onmouseleave="hideTooltip('income-tip')">
                        <svg class="w-5 h-5 text-gray-400 hover:text-green-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div id="income-tip" class="hidden absolute bottom-full right-0 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50 shadow-xl">
                            Payments received from clients, platforms, or jobs.
                            <div class="absolute top-full right-4 -mt-1">
                                <div class="border-4 border-transparent border-t-gray-900"></div>
                            </div>
                        </div>
                    </button>
                </div>
                <p class="text-xs md:text-sm text-gray-600 mb-1 font-medium">Total Income</p>
                <div class="flex flex-col md:flex-row md:items-baseline gap-0.5 md:gap-2">
                    <div id="total-income-loading" class="h-7 md:h-10 w-16 md:w-32 bg-gray-200 rounded animate-pulse"></div>
                    <p id="total-income" class="text-base md:text-3xl font-bold text-accent hidden leading-tight"></p>
                    <span id="income-trend" class="text-xs md:text-sm font-semibold mt-0.5 md:mt-0"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1 md:mt-2 hidden md:block">This month</p>
            </div>
            
            <!-- Card 2: Total Expenses -->
            <div class="bg-white rounded-lg md:rounded-2xl p-3 md:p-6 shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 group relative">
                <div class="flex flex-col md:flex-row items-start md:justify-between mb-2 md:mb-4">
                    <div class="w-8 h-8 md:w-12 md:h-12 bg-red-100 rounded-lg md:rounded-xl flex items-center justify-center mb-2 md:mb-0">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <button class="group/tooltip relative" onmouseenter="showTooltip('expense-tip')" onmouseleave="hideTooltip('expense-tip')">
                        <svg class="w-5 h-5 text-gray-400 hover:text-red-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div id="expense-tip" class="hidden absolute bottom-full right-0 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50 shadow-xl">
                            Business-related spending like gas, tolls, or maintenance.
                            <div class="absolute top-full right-4 -mt-1">
                                <div class="border-4 border-transparent border-t-gray-900"></div>
                            </div>
                        </div>
                    </button>
                </div>
                <p class="text-xs md:text-sm text-gray-600 mb-1 font-medium">Total Expenses</p>
                <div class="flex flex-col md:flex-row md:items-baseline gap-0.5 md:gap-2">
                    <div id="total-expenses-loading" class="h-7 md:h-10 w-16 md:w-32 bg-gray-200 rounded animate-pulse"></div>
                    <p id="total-expenses" class="text-base md:text-3xl font-bold text-danger hidden leading-tight"></p>
                    <span id="expense-trend" class="text-xs md:text-sm font-semibold mt-0.5 md:mt-0"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1 md:mt-2 hidden md:block">This month</p>
            </div>
            
            <!-- Card 3: Net Profit -->
            <div id="net-profit-card" class="bg-primary rounded-lg md:rounded-2xl p-3 md:p-6 shadow-lg text-white transition-all duration-300 group relative">
                <div class="flex flex-col md:flex-row items-start md:justify-between mb-2 md:mb-4">
                    <div class="w-8 h-8 md:w-12 md:h-12 bg-white/20 rounded-lg md:rounded-xl flex items-center justify-center mb-2 md:mb-0">
                        <svg id="net-profit-icon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <button class="group/tooltip relative" onmouseenter="showTooltip('profit-tip')" onmouseleave="hideTooltip('profit-tip')">
                        <svg class="w-5 h-5 text-white/70 hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div id="profit-tip" class="hidden absolute bottom-full right-0 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg py-2 px-3 z-50 shadow-xl">
                            Your income minus expenses this month. This shows how much your business keeps after costs.
                            <div class="absolute top-full right-4 -mt-1">
                                <div class="border-4 border-transparent border-t-gray-900"></div>
                </div>
            </div>
                    </button>
                </div>
                <p class="text-xs md:text-sm opacity-90 mb-1 font-medium">Net Profit</p>
                <div class="flex flex-col md:flex-row md:items-baseline gap-0.5 md:gap-2">
                    <div id="net-profit-loading" class="h-7 md:h-10 w-16 md:w-32 bg-white/20 rounded animate-pulse"></div>
                    <p id="net-profit" class="text-base md:text-3xl font-bold hidden leading-tight"></p>
                    <span id="profit-trend" class="text-xs md:text-sm font-semibold opacity-90 mt-0.5 md:mt-0"></span>
                </div>
                <p class="text-xs opacity-80 mt-1 md:mt-2 hidden md:block">Income - Expenses</p>
            </div>
        </div>
        
        <!-- AI Insight -->
        <div id="ai-insight-container" class="mb-8">
            <!-- AI insight will be inserted here -->
        </div>
        
        <!-- Quick Actions -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-6 md:mb-8">
            <button onclick="openIncomeModal()" class="group bg-white rounded-xl p-4 md:p-4 shadow-sm border-2 border-gray-200 hover:shadow-lg hover:border-blue-500 hover:scale-[1.02] transition-all duration-200 flex items-center gap-3 cursor-pointer active:scale-[0.98] relative min-h-[80px]" title="Rideshare payout, private client trip, or affiliate job">
                <div class="w-11 h-11 md:w-10 md:h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors flex-shrink-0">
                    <svg class="w-6 h-6 md:w-5 md:h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </div>
                <div class="text-left flex-1">
                    <p class="font-semibold text-sm md:text-base text-gray-900">Add Income</p>
                    <p class="text-xs text-gray-500 hidden md:block">Log new income</p>
                </div>
            </button>
            
            <button onclick="openExpenseModal()" class="group bg-white rounded-xl p-4 md:p-4 shadow-sm border-2 border-gray-200 hover:shadow-lg hover:border-red-500 hover:scale-[1.02] transition-all duration-200 flex items-center gap-3 cursor-pointer active:scale-[0.98] relative min-h-[80px]" title="Gas, tolls, insurance, car wash, or repairs">
                <div class="w-11 h-11 md:w-10 md:h-10 bg-red-100 rounded-lg flex items-center justify-center group-hover:bg-red-200 transition-colors flex-shrink-0">
                    <svg class="w-6 h-6 md:w-5 md:h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                </div>
                <div class="text-left flex-1">
                    <p class="font-semibold text-sm md:text-base text-gray-900">Add Expense</p>
                    <p class="text-xs text-gray-500 hidden md:block">Track spending</p>
                </div>
            </button>
            
            <button class="relative group bg-white rounded-xl p-4 md:p-4 shadow-sm border-2 border-gray-200 transition-all duration-200 flex items-center gap-3 opacity-60 cursor-not-allowed min-h-[80px]">
                <div class="w-11 h-11 md:w-10 md:h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 md:w-5 md:h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </div>
                <div class="text-left flex-1">
                    <p class="font-semibold text-sm md:text-base text-gray-700">Scan Receipt</p>
                    <p class="text-xs text-purple-600 font-medium hidden md:block">Coming Q1 2026</p>
                </div>
                <div class="absolute top-2 right-2 bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded-full">SOON</div>
            </button>
            
            <button class="relative group bg-white rounded-xl p-4 md:p-4 shadow-sm border-2 border-gray-200 transition-all duration-200 flex items-center gap-3 opacity-60 cursor-not-allowed min-h-[80px]">
                <div class="w-11 h-11 md:w-10 md:h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 md:w-5 md:h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div class="text-left flex-1">
                    <p class="font-semibold text-sm md:text-base text-gray-700">Export Report</p>
                    <p class="text-xs text-green-600 font-medium hidden md:block">Coming Q1 2026</p>
                </div>
                <div class="absolute top-2 right-2 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-full">SOON</div>
            </button>
        </div>
        
        <!-- Balance Sheet Snapshot -->
        <div class="bg-blue-50 rounded-2xl p-6 shadow-sm border-2 border-blue-100 mb-8">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            </div>
                        Your Business Value
                    </h3>
                    <p class="text-sm text-gray-600 ml-12">What you have vs. what you owe</p>
                    </div>
                    
            <!-- Balance Sheet Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- What You Have -->
                <div class="bg-white border border-green-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            </div>
                        <p class="text-xs text-gray-600 font-medium">What You Have</p>
                            </div>
                    <div id="dashboard-total-assets-loading" class="h-8 w-24 bg-gray-200 rounded animate-pulse"></div>
                    <p id="dashboard-total-assets" class="text-2xl font-bold text-green-600 hidden"></p>
                    <p class="text-xs text-gray-500 mt-1">Cars, equipment, cash</p>
                    </div>
                    
                <!-- What You Owe -->
                <div class="bg-white border border-red-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            </div>
                        <p class="text-xs text-gray-600 font-medium">What You Owe</p>
                            </div>
                    <div id="dashboard-total-liabilities-loading" class="h-8 w-24 bg-gray-200 rounded animate-pulse"></div>
                    <p id="dashboard-total-liabilities" class="text-2xl font-bold text-red-600 hidden"></p>
                    <p class="text-xs text-gray-500 mt-1">Loans, leases</p>
                        </div>

                <!-- Money In/Out -->
                <div class="bg-white border border-purple-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <p class="text-xs text-gray-600 font-medium">Money In/Out</p>
                    </div>
                    <div id="dashboard-net-equity-loading" class="h-8 w-24 bg-gray-200 rounded animate-pulse"></div>
                    <p id="dashboard-net-equity" class="text-2xl font-bold text-purple-600 hidden"></p>
                    <p class="text-xs text-gray-500 mt-1">Your investment</p>
                    </div>
                    
                <!-- Business Value -->
                <div class="bg-blue-600 rounded-xl p-4 text-white">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            </div>
                        <p class="text-xs opacity-90 font-medium">Business Value</p>
                            </div>
                    <div id="dashboard-net-worth-loading" class="h-8 w-24 bg-white/20 rounded animate-pulse"></div>
                    <p id="dashboard-net-worth" class="text-2xl font-bold hidden"></p>
                    <p class="text-xs opacity-80 mt-1">Total worth</p>
                        </div>
                    </div>
                    
            <!-- Quick Tip -->
            <div class="mt-4 bg-white border border-blue-200 rounded-lg px-4 py-3">
                <p class="text-sm text-blue-800">
                    ðŸ’¡ <strong>Why this matters:</strong> Banks and lenders look at your business value when you apply for loans or financing. Keep this updated!
                </p>
                            </div>
                            </div>
        
        <!-- Recent Activity & Profit Chart -->
        <div class="grid lg:grid-cols-3 gap-6">
            
            <!-- Recent Activity -->
            <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-textDark">Recent Activity</h3>
                    <span id="activity-count" class="text-sm text-gray-500">0 items</span>
                        </div>
                
                <div id="recent-activity" class="space-y-3 mb-4">
                    <!-- Loading state -->
                    <div class="text-center py-8 text-gray-500">
                        <p>Loading activity...</p>
                    </div>
                </div>
                
                <!-- Pagination Controls -->
                <div id="activity-pagination" class="hidden flex items-center justify-between pt-4 border-t border-gray-200">
                    <button id="prev-page" onclick="changeActivityPage(-1)" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200" disabled>
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Previous
                    </button>
                    <span id="page-info" class="text-sm text-gray-600">Page 1 of 1</span>
                    <button id="next-page" onclick="changeActivityPage(1)" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200" disabled>
                        Next
                        <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Profit Trend -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 h-fit">
                <h3 id="summary-title" class="text-xl font-bold text-textDark mb-2">Current Month Summary</h3>
                <p id="summary-subtitle" class="text-xs text-gray-500 mb-6">Your activity this month</p>
                
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">Trips</span>
                            <span id="week-trips" class="font-bold text-gray-900">0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="week-trips-bar" class="bg-accent h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">Hours</span>
                            <span id="week-hours" class="font-bold text-gray-900">0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="week-hours-bar" class="bg-primary h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">Miles</span>
                            <span id="week-miles" class="font-bold text-gray-900">0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="week-miles-bar" class="bg-purple-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-sm text-gray-600 mb-2">Avg. per trip</p>
                    <p id="avg-per-trip" class="text-2xl font-bold text-primary">$0.00</p>
                </div>
                
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-2">Top expense</p>
                    <p id="top-expense" class="text-lg font-semibold text-gray-900">â€”</p>
                </div>
            </div>
        </div>
        
        <!-- Educational Tip -->
        <div class="mt-8 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                <div>
                    <p class="text-sm font-semibold text-blue-900 mb-1">Pro Tip</p>
                    <p class="text-sm text-blue-800">Keeping your expenses up to date helps you stay ready for tax season. Track every gas fill-up, toll, and car wash!</p>
                </div>
            </div>
        </div>
        
        <!-- Welcome Banner (only shown when user has no data) -->
        <div id="welcome-banner" class="hidden mt-8 bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-8 text-center text-white shadow-xl">
            <div class="flex items-center justify-center gap-2 mb-3">
                <svg class="w-6 h-6 text-yellow-300" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                </svg>
                <h3 class="text-2xl font-bold">Welcome to ChauFlow Beta!</h3>
                <svg class="w-6 h-6 text-yellow-300" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                </svg>
            </div>
            <p class="text-blue-100 mb-6 max-w-2xl mx-auto">You're using the early access version. Start tracking your first trip or expense to see real-time insights!</p>
            <div class="flex flex-wrap items-center justify-center gap-4">
                <button onclick="openIncomeModal()" class="px-6 py-3 bg-white text-blue-600 rounded-lg font-semibold hover:bg-blue-50 hover:shadow-lg transition-all duration-200 flex items-center gap-2 active:scale-95">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Log Your First Trip
                </button>
                <button onclick="openExpenseModal()" class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-400 hover:shadow-lg transition-all duration-200 flex items-center gap-2 border-2 border-white/20 active:scale-95">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                    Track An Expense
            </button>
            </div>
            <div class="mt-6 pt-6 border-t border-white/20">
                <p class="text-sm text-blue-200">
                    <span class="font-semibold">Coming Q1 2026:</span> Receipt scanning, tax reports, mileage tracking, and more
                </p>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="mt-16 py-8 px-4 bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto text-center text-sm text-gray-500">
            <p>Â© 2025 ChauFlow. All rights reserved.</p>
        </div>
    </footer>

    <!-- Add Income Modal -->
    <div id="income-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75 backdrop-blur-sm" onclick="closeIncomeModal()"></div>
            
            <!-- Modal panel -->
            <div class="relative bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Add Income</h3>
                        <button onclick="closeIncomeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="income-form" class="space-y-4">
                        <!-- Amount -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Amount *</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                <input type="text" id="income-amount" inputmode="numeric" required
                                    class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="0">
                            </div>
                        </div>
                        
                        <!-- Source -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Source *</label>
                            <select id="income-source" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Select income source</option>
                                <optgroup label="Primary Driving Income">
                                    <option value="Rideshare App Income">Rideshare App Income</option>
                                    <option value="Black Car Jobs">Black Car Jobs</option>
                                    <option value="Direct Client Income">Direct Client Income</option>
                                    <option value="Airport Transfers">Airport Transfers</option>
                                    <option value="Hourly Charters">Hourly Charters</option>
                                    <option value="Long-Distance Trips">Long-Distance Trips</option>
                                </optgroup>
                                <optgroup label="Tips & Bonuses">
                                    <option value="Cash Tips">Cash Tips</option>
                                    <option value="Digital Tips">Digital Tips</option>
                                    <option value="Referral Bonuses">Referral Bonuses</option>
                                    <option value="Platform Bonuses">Platform Bonuses</option>
                                </optgroup>
                                <optgroup label="Miscellaneous Income">
                                    <option value="Wait Time Charges">Wait Time Charges</option>
                                    <option value="Additional Stop Fees">Additional Stop Fees</option>
                                    <option value="Toll Reimbursements">Toll Reimbursements</option>
                                    <option value="Cancellation Fees">Cancellation Fees</option>
                                    <option value="Event Package Income">Event Package Income</option>
                                </optgroup>
                                <optgroup label="Optional Income">
                                    <option value="Vehicle Rental Income">Vehicle Rental Income</option>
                                    <option value="Vehicle Advertising">Vehicle Advertising</option>
                                    <option value="Other Income">Other Income</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <!-- Date -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                            <input type="date" id="income-date" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Description (Optional)</label>
                            <input type="text" id="income-description"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="e.g., Evening shift, Airport run">
                        </div>
                        
                        <!-- Optional Trip Details -->
                        <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                            <p class="text-sm font-semibold text-gray-700 mb-2">Trip Details (Optional)</p>
                            
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Trips</label>
                                    <input type="number" id="income-trips" min="0" step="1"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                        placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Hours</label>
                                    <input type="number" id="income-hours" min="0" step="0.5"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                        placeholder="0.0">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Miles</label>
                                    <input type="number" id="income-miles" min="0" step="0.1"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                        placeholder="0.0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error Message -->
                        <div id="income-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                            <p class="text-sm text-red-600 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span id="income-error-message"></span>
                            </p>
                        </div>
                        
                        <!-- Success Message -->
                        <div id="income-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-600 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                Income added successfully!
                            </p>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="closeIncomeModal()"
                                class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" id="income-submit-btn"
                                class="flex-1 px-4 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Income
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="expense-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75 backdrop-blur-sm" onclick="closeExpenseModal()"></div>
            
            <!-- Modal panel -->
            <div class="relative bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Add Expense</h3>
                        <button onclick="closeExpenseModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="expense-form" class="space-y-4">
                        <!-- Amount -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Amount *</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">$</span>
                                <input type="text" id="expense-amount" inputmode="numeric" required
                                    class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="0">
                            </div>
                        </div>
                        
                        <!-- Category -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Category *</label>
                            <select id="expense-category" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Select category</option>
                                <option value="Gas">Gas</option>
                                <option value="Tolls">Tolls</option>
                                <option value="Parking">Parking</option>
                                <option value="Car Wash">Car Wash</option>
                                <option value="Maintenance & Repairs">Maintenance & Repairs</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Car Payment">Car Payment</option>
                                <option value="Phone Bill">Phone Bill</option>
                                <option value="Supplies">Supplies</option>
                                <option value="Meals">Meals</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <!-- Date -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                            <input type="date" id="expense-date" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <!-- Vendor -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Vendor (Optional)</label>
                            <input type="text" id="expense-vendor"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="e.g., Shell, EZPass">
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Description (Optional)</label>
                            <input type="text" id="expense-description"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="e.g., Fill up, Toll road">
                        </div>
                        
                        <!-- Error Message -->
                        <div id="expense-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                            <p class="text-sm text-red-600 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span id="expense-error-message"></span>
                            </p>
                        </div>
                        
                        <!-- Success Message -->
                        <div id="expense-success" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-600 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                Expense added successfully!
                            </p>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="closeExpenseModal()"
                                class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" id="expense-submit-btn"
                                class="flex-1 px-4 py-3 bg-danger text-white rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Expense
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://bvrdimwnarfobmwvthyb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2cmRpbXduYXJmb2Jtd3Z0aHliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMjAxMzcsImV4cCI6MjA3Nzc5NjEzN30.vweZ-F-sG4rYJT1CM1OH0QONmEt73_TMV0F-emMuj8k';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global user session
        let currentUser = null;
        
        // DOM Elements
        const userEmailElement = document.getElementById('user-email');
        const signoutBtn = document.getElementById('signout-btn');
        
        // Modal Elements
        const incomeModal = document.getElementById('income-modal');
        const expenseModal = document.getElementById('expense-modal');
        const incomeForm = document.getElementById('income-form');
        const expenseForm = document.getElementById('expense-form');
        
        // ============================================
        // Authentication
        // ============================================
        
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = session.user;
            if (userEmailElement) {
                userEmailElement.textContent = currentUser.email || 'Driver';
            }
            
            // Update email in dropdown menu
            const userEmailMenu = document.getElementById('user-email-menu');
            if (userEmailMenu) {
                userEmailMenu.textContent = currentUser.email || 'Driver';
            }
            
            // Update email in mobile menu
            const mobileUserEmail = document.getElementById('mobile-user-email');
            if (mobileUserEmail) {
                mobileUserEmail.textContent = currentUser.email || 'Driver';
            }
            
            // Load dashboard data
            await loadDashboardData();
            
            // Calculate trends after data loads
            await calculateTrends();
        }
        
        // ============================================
        // Mobile Navigation Toggle
        // ============================================
        const mobileNavBtn = document.getElementById('mobile-nav-btn');
        const mobileNavMenu = document.getElementById('mobile-nav-menu');
        const mobileMenuIcon = document.getElementById('mobile-menu-icon');
        const mobileCloseIcon = document.getElementById('mobile-close-icon');

        if (mobileNavBtn) {
            mobileNavBtn.addEventListener('click', () => {
                mobileNavMenu.classList.toggle('hidden');
                mobileMenuIcon.classList.toggle('hidden');
                mobileCloseIcon.classList.toggle('hidden');
            });
        }

        // ============================================
        // User Menu Toggle
        // ============================================
        
        function toggleUserMenu() {
            const userMenu = document.getElementById('user-menu');
            userMenu.classList.toggle('hidden');
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenuBtn = document.getElementById('user-menu-btn');
            const userMenu = document.getElementById('user-menu');
            
            if (userMenuBtn && userMenu && !userMenuBtn.contains(event.target) && !userMenu.contains(event.target)) {
                userMenu.classList.add('hidden');
            }
        });
        
        // Sign out handlers (desktop and mobile)
        const handleSignOut = async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                alert('Error signing out: ' + error.message);
            } else {
                window.location.href = 'index.html';
            }
        };
        
        signoutBtn.addEventListener('click', handleSignOut);
        
        const mobileSignoutBtn = document.getElementById('mobile-signout-btn');
        if (mobileSignoutBtn) {
            mobileSignoutBtn.addEventListener('click', handleSignOut);
        }
        
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = 'login.html';
            }
        });
        
        // ============================================
        // Modal Functions
        // ============================================
        
        let editingIncomeId = null;
        
        async function openIncomeModal(incomeId = null) {
            editingIncomeId = incomeId;
            
            // Update modal title and button
            const modalTitle = incomeModal.querySelector('h3');
            const submitBtn = document.getElementById('income-submit-btn');
            
            if (incomeId) {
                // Edit mode - load existing data FIRST
                modalTitle.textContent = 'Edit Income';
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Update Income';
                await loadIncomeForEdit(incomeId);
            } else {
                // New mode
                modalTitle.textContent = 'Add Income';
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Income';
                document.getElementById('income-date').valueAsDate = new Date();
            }
            
            // Show modal AFTER data is loaded
            incomeModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        async function loadIncomeForEdit(incomeId) {
            try {
                const { data, error } = await supabase
                    .from('income')
                    .select('*')
                    .eq('id', incomeId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                console.log('Loaded income data:', data); // Debug log
                
                // Populate form with existing data
                document.getElementById('income-amount').value = parseFloat(data.amount).toFixed(2);
                
                // Set both the hidden input and visible input for source (smart modal compatibility)
                const sourceHidden = document.getElementById('income-source');
                const sourceInput = document.getElementById('income-source-input');
                if (sourceHidden) sourceHidden.value = data.source;
                if (sourceInput) sourceInput.value = data.source;
                
                document.getElementById('income-date').value = data.date.split('T')[0];
                document.getElementById('income-description').value = data.description || '';
                document.getElementById('income-trips').value = data.trip_count || '';
                document.getElementById('income-hours').value = data.hours_worked || '';
                document.getElementById('income-miles').value = data.miles_driven || '';
                
                console.log('Source set to:', data.source); // Debug log
                
            } catch (error) {
                console.error('Error loading income for edit:', error);
                alert('Failed to load income data. Please try again.');
                closeIncomeModal();
            }
        }
        
        function closeIncomeModal() {
            incomeModal.classList.add('hidden');
            incomeForm.reset();
            editingIncomeId = null;
            document.getElementById('income-error').classList.add('hidden');
            document.getElementById('income-success').classList.add('hidden');
            // Reset modal title and button
            const modalTitle = incomeModal.querySelector('h3');
            const submitBtn = document.getElementById('income-submit-btn');
            modalTitle.textContent = 'Add Income';
            submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Income';
            document.body.style.overflow = 'auto';
        }
        
        let editingExpenseId = null;
        
        async function openExpenseModal(expenseId = null) {
            editingExpenseId = expenseId;
            
            // Update modal title and button
            const modalTitle = expenseModal.querySelector('h3');
            const submitBtn = document.getElementById('expense-submit-btn');
            
            if (expenseId) {
                // Edit mode - load existing data FIRST
                modalTitle.textContent = 'Edit Expense';
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Update Expense';
                await loadExpenseForEdit(expenseId);
            } else {
                // New mode
                modalTitle.textContent = 'Add Expense';
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Expense';
                document.getElementById('expense-date').valueAsDate = new Date();
            }
            
            // Show modal AFTER data is loaded
            expenseModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        async function loadExpenseForEdit(expenseId) {
            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('id', expenseId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                // Populate form with existing data
                document.getElementById('expense-amount').value = parseFloat(data.amount).toFixed(2);
                document.getElementById('expense-category').value = data.category;
                document.getElementById('expense-date').value = data.date.split('T')[0];
                document.getElementById('expense-vendor').value = data.vendor || '';
                document.getElementById('expense-description').value = data.description || '';
                
            } catch (error) {
                console.error('Error loading expense for edit:', error);
                alert('Failed to load expense data. Please try again.');
                closeExpenseModal();
            }
        }
        
        function closeExpenseModal() {
            expenseModal.classList.add('hidden');
            expenseForm.reset();
            editingExpenseId = null;
            document.getElementById('expense-error').classList.add('hidden');
            document.getElementById('expense-success').classList.add('hidden');
            // Reset modal title and button
            const modalTitle = expenseModal.querySelector('h3');
            const submitBtn = document.getElementById('expense-submit-btn');
            modalTitle.textContent = 'Add Expense';
            submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Expense';
            document.body.style.overflow = 'auto';
        }
        
        // ============================================
        // Income Form Submission
        // ============================================
        
        incomeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('income-submit-btn');
            const errorDiv = document.getElementById('income-error');
            const errorMsg = document.getElementById('income-error-message');
            const successDiv = document.getElementById('income-success');
            
            // Hide messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            
            try {
                // Get form data (remove commas from amount)
                const amountValue = unformatCurrency(document.getElementById('income-amount'));
                const amount = parseFloat(amountValue);
                const source = document.getElementById('income-source').value;
                const date = document.getElementById('income-date').value;
                const description = document.getElementById('income-description').value || null;
                const trips = document.getElementById('income-trips').value || null;
                const hours = document.getElementById('income-hours').value || null;
                const miles = document.getElementById('income-miles').value || null;
                
                let data, error;
                
                if (editingIncomeId) {
                    // Update existing income
                    const { data: updateData, error: updateError } = await supabase
                        .from('income')
                        .update({
                            amount: amount,
                            source: source,
                            date: date,
                            description: description,
                            trip_count: trips ? parseInt(trips) : null,
                            hours_worked: hours ? parseFloat(hours) : null,
                            miles_driven: miles ? parseFloat(miles) : null
                        })
                        .eq('id', editingIncomeId)
                        .eq('user_id', currentUser.id)
                        .select();
                    
                    data = updateData;
                    error = updateError;
                } else {
                    // Insert new income
                    const { data: insertData, error: insertError } = await supabase
                        .from('income')
                        .insert([{
                            user_id: currentUser.id,
                            amount: amount,
                            source: source,
                            date: date,
                            description: description,
                            trip_count: trips ? parseInt(trips) : null,
                            hours_worked: hours ? parseFloat(hours) : null,
                            miles_driven: miles ? parseFloat(miles) : null
                        }])
                        .select();
                    
                    data = insertData;
                    error = insertError;
                }
                
                if (error) throw error;
                
                // Reset form
                incomeForm.reset();
                
                // Trigger confetti FIRST!
                celebrateMoneyRain();
                
                // Then close modal after short delay
                setTimeout(() => {
                    closeIncomeModal();
                }, 300);
                
                // Reload dashboard data in background
                loadDashboardData();
                
            } catch (error) {
                console.error('Error adding income:', error);
                errorMsg.textContent = error.message || 'Failed to add income. Please try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Income';
            }
        });
        
        // ============================================
        // Expense Form Submission
        // ============================================
        
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('expense-submit-btn');
            const errorDiv = document.getElementById('expense-error');
            const errorMsg = document.getElementById('expense-error-message');
            const successDiv = document.getElementById('expense-success');
            
            // Hide messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            
            try {
                // Get form data (remove commas from amount)
                const amountValue = unformatCurrency(document.getElementById('expense-amount'));
                const amount = parseFloat(amountValue);
                const category = document.getElementById('expense-category').value;
                const date = document.getElementById('expense-date').value;
                const vendor = document.getElementById('expense-vendor').value || null;
                const description = document.getElementById('expense-description').value || null;
                
                let data, error;
                
                if (editingExpenseId) {
                    // Update existing expense
                    const { data: updateData, error: updateError } = await supabase
                        .from('expenses')
                        .update({
                            amount: amount,
                            category: category,
                            date: date,
                            vendor: vendor,
                            description: description
                        })
                        .eq('id', editingExpenseId)
                        .eq('user_id', currentUser.id)
                        .select();
                    
                    data = updateData;
                    error = updateError;
                } else {
                    // Insert new expense
                    const { data: insertData, error: insertError } = await supabase
                        .from('expenses')
                        .insert([{
                            user_id: currentUser.id,
                            amount: amount,
                            category: category,
                            date: date,
                            vendor: vendor,
                            description: description
                        }])
                        .select();
                    
                    data = insertData;
                    error = insertError;
                }
                
                if (error) throw error;
                
                // Reset form
                expenseForm.reset();
                
                // Trigger confetti FIRST!
                celebrateSuccess();
                
                // Then close modal after short delay
                setTimeout(() => {
                    closeExpenseModal();
                }, 300);
                
                // Reload dashboard data in background
                loadDashboardData();
                
            } catch (error) {
                console.error('Error adding expense:', error);
                errorMsg.textContent = error.message || 'Failed to add expense. Please try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Add Expense';
            }
        });
        
        // ============================================
        // Quick Filter Functions
        // ============================================
        
        let currentDashboardFilter = 'thisMonth'; // Default to This Month
        
        function applyDashboardQuickFilter(filterType) {
            currentDashboardFilter = filterType;
            
            // Update button styles
            document.querySelectorAll('.dashboard-filter-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-100', 'text-gray-700');
            event.target.classList.add('bg-primary', 'text-white');
            
            // Update summary title based on filter
            updateSummaryTitle(filterType);
            
            // Reload data with new filter
            loadDashboardData();
            loadRecentActivity();
        }
        
        function updateSummaryTitle(filterType) {
            const titleEl = document.getElementById('summary-title');
            const subtitleEl = document.getElementById('summary-subtitle');
            
            if (!titleEl || !subtitleEl) return;
            
            const titles = {
                'today': { title: 'Today\'s Summary', subtitle: 'Your activity today' },
                'yesterday': { title: 'Yesterday\'s Summary', subtitle: 'Your activity yesterday' },
                'thisMonth': { title: 'Current Month Summary', subtitle: 'Your activity this month' },
                'lastMonth': { title: 'Last Month Summary', subtitle: 'Your activity last month' },
                'last30Days': { title: 'Last 30 Days Summary', subtitle: 'Your activity over the last 30 days' },
                'last90Days': { title: 'Last 90 Days Summary', subtitle: 'Your activity over the last 90 days' },
                'thisYear': { title: 'Year to Date Summary', subtitle: 'Your activity this year' },
                'lastYear': { title: 'Last Year Summary', subtitle: 'Your activity last year' },
                'allTime': { title: 'All Time Summary', subtitle: 'Your complete activity history' }
            };
            
            const config = titles[filterType] || titles['thisMonth'];
            titleEl.textContent = config.title;
            subtitleEl.textContent = config.subtitle;
        }
        
        function getDashboardDateRange() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (currentDashboardFilter) {
                case 'today':
                    return {
                        start: today.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    return {
                        start: yesterday.toISOString().split('T')[0],
                        end: yesterday.toISOString().split('T')[0]
                    };
                case 'thisMonth':
                    return {
                        start: new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0],
                        end: new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]
                    };
                case 'lastMonth':
                    return {
                        start: new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0],
                        end: new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0]
                    };
                case 'last30Days':
                    const last30 = new Date(today);
                    last30.setDate(today.getDate() - 30);
                    return {
                        start: last30.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'last90Days':
                    const last90 = new Date(today);
                    last90.setDate(today.getDate() - 90);
                    return {
                        start: last90.toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'thisYear':
                    return {
                        start: new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0],
                        end: today.toISOString().split('T')[0]
                    };
                case 'lastYear':
                    return {
                        start: new Date(now.getFullYear() - 1, 0, 1).toISOString().split('T')[0],
                        end: new Date(now.getFullYear() - 1, 11, 31).toISOString().split('T')[0]
                    };
                case 'allTime':
                default:
                    return { start: null, end: null };
            }
        }
        
        // ============================================
        // Load Dashboard Data
        // ============================================
        
        async function loadDashboardData() {
            if (!currentUser) return;
            
            try {
                // Show skeleton loaders
                document.getElementById('stats-skeleton')?.classList.remove('hidden');
                document.getElementById('stats-cards')?.classList.add('hidden');
                
                // Get date range from quick filter
                const dateRange = getDashboardDateRange();
                
                // Build income query with date filter
                let incomeQuery = supabase
                    .from('income')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                // Apply date filter if not "All Time"
                if (dateRange.start) {
                    incomeQuery = incomeQuery.gte('date', dateRange.start);
                }
                if (dateRange.end) {
                    incomeQuery = incomeQuery.lte('date', dateRange.end);
                }
                
                const { data: incomeData, error: incomeError } = await incomeQuery;
                
                if (incomeError) throw incomeError;
                
                // Build expenses query with date filter
                let expenseQuery = supabase
                    .from('expenses')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                // Apply date filter if not "All Time"
                if (dateRange.start) {
                    expenseQuery = expenseQuery.gte('date', dateRange.start);
                }
                if (dateRange.end) {
                    expenseQuery = expenseQuery.lte('date', dateRange.end);
                }
                
                const { data: expenseData, error: expenseError } = await expenseQuery;
                
                if (expenseError) throw expenseError;
                
                // Calculate totals
                const totalIncome = incomeData.reduce((sum, item) => sum + parseFloat(item.amount), 0);
                const totalExpenses = expenseData.reduce((sum, item) => sum + parseFloat(item.amount), 0);
                const netProfit = totalIncome - totalExpenses;
                
                // Hide loading skeletons
                document.getElementById('total-income-loading')?.classList.add('hidden');
                document.getElementById('total-expenses-loading')?.classList.add('hidden');
                document.getElementById('net-profit-loading')?.classList.add('hidden');
                
                // Update and show stats cards
                const incomeEl = document.getElementById('total-income');
                const expensesEl = document.getElementById('total-expenses');
                const profitEl = document.getElementById('net-profit');
                
                if (incomeEl) {
                    incomeEl.textContent = formatCurrencyDisplay(totalIncome);
                    incomeEl.classList.remove('hidden');
                }
                if (expensesEl) {
                    expensesEl.textContent = formatCurrencyDisplay(totalExpenses);
                    expensesEl.classList.remove('hidden');
                }
                if (profitEl) {
                    profitEl.textContent = formatCurrencyDisplay(netProfit);
                    profitEl.classList.remove('hidden');
                }
                
                // Load Balance Sheet data
                await loadBalanceSheetData();
                
                // Hide skeleton, show real cards
                document.getElementById('stats-skeleton')?.classList.add('hidden');
                document.getElementById('stats-cards')?.classList.remove('hidden');
                
                // Update Net Profit card styling based on value
                const netProfitCard = document.getElementById('net-profit-card');
                const netProfitIcon = document.getElementById('net-profit-icon');
                const netProfitBadge = document.getElementById('net-profit-badge');
                
                if (netProfitCard && netProfitIcon) {
                    if (netProfit > 0) {
                        // Profit - Green with upward arrow
                        netProfitCard.className = 'bg-green-600 rounded-2xl p-6 shadow-lg text-white transition-all duration-300';
                        netProfitIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>';
                        if (netProfitBadge) netProfitBadge.textContent = 'Profit';
                    } else if (netProfit < 0) {
                        // Loss - Red with downward arrow
                        netProfitCard.className = 'bg-red-600 rounded-2xl p-6 shadow-lg text-white transition-all duration-300';
                        netProfitIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0v-8m0 8l-8-8-4 4-6-6"></path>';
                        if (netProfitBadge) netProfitBadge.textContent = 'Loss';
                    } else {
                        // Break Even - Gray with neutral icon
                        netProfitCard.className = 'bg-gray-600 rounded-2xl p-6 shadow-lg text-white transition-all duration-300';
                        netProfitIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14"></path>';
                        if (netProfitBadge) netProfitBadge.textContent = 'Break Even';
                    }
                }
                
                // Update badges
                const incomeBadge = document.getElementById('income-badge');
                const expenseBadge = document.getElementById('expense-badge');
                if (incomeBadge) incomeBadge.textContent = `${incomeData.length} entries`;
                if (expenseBadge) expenseBadge.textContent = `${expenseData.length} entries`;
                
                // Show/hide welcome banner based on whether user has any data
                const welcomeBanner = document.getElementById('welcome-banner');
                if (welcomeBanner) {
                    const hasAnyData = incomeData.length > 0 || expenseData.length > 0;
                    if (hasAnyData) {
                        welcomeBanner.classList.add('hidden');
                    } else {
                        welcomeBanner.classList.remove('hidden');
                    }
                }
                
                // Calculate trip stats
                const totalTrips = incomeData.reduce((sum, item) => sum + (parseInt(item.trip_count) || 0), 0);
                const totalHours = incomeData.reduce((sum, item) => sum + (parseFloat(item.hours_worked) || 0), 0);
                const totalMiles = incomeData.reduce((sum, item) => sum + (parseFloat(item.miles_driven) || 0), 0);
                const avgPerTrip = totalTrips > 0 ? totalIncome / totalTrips : 0;
                
                const weekTripsEl = document.getElementById('week-trips');
                const weekHoursEl = document.getElementById('week-hours');
                const weekMilesEl = document.getElementById('week-miles');
                const avgPerTripEl = document.getElementById('avg-per-trip');
                
                if (weekTripsEl) weekTripsEl.textContent = formatNumber(totalTrips);
                if (weekHoursEl) weekHoursEl.textContent = formatNumber(totalHours);
                if (weekMilesEl) weekMilesEl.textContent = formatNumber(totalMiles);
                if (avgPerTripEl) avgPerTripEl.textContent = formatCurrencyDisplay(avgPerTrip);
                
                // Update progress bars (max values for scaling)
                const maxTrips = 200;
                const maxHours = 200;
                const maxMiles = 5000;
                
                const weekTripsBar = document.getElementById('week-trips-bar');
                const weekHoursBar = document.getElementById('week-hours-bar');
                const weekMilesBar = document.getElementById('week-miles-bar');
                
                if (weekTripsBar) weekTripsBar.style.width = `${Math.min(100, (totalTrips / maxTrips) * 100)}%`;
                if (weekHoursBar) weekHoursBar.style.width = `${Math.min(100, (totalHours / maxHours) * 100)}%`;
                if (weekMilesBar) weekMilesBar.style.width = `${Math.min(100, (totalMiles / maxMiles) * 100)}%`;
                
                // Find top expense category
                const expenseByCategory = {};
                expenseData.forEach(item => {
                    if (!expenseByCategory[item.category]) {
                        expenseByCategory[item.category] = 0;
                    }
                    expenseByCategory[item.category] += parseFloat(item.amount);
                });
                
                let topCategory = null;
                let topAmount = 0;
                for (const [category, amount] of Object.entries(expenseByCategory)) {
                    if (amount > topAmount) {
                        topAmount = amount;
                        topCategory = category;
                    }
                }
                
                const topExpenseEl = document.getElementById('top-expense');
                if (topExpenseEl) {
                    if (topCategory) {
                        topExpenseEl.textContent = `${topCategory} (${formatCurrencyDisplay(topAmount)})`;
                    } else {
                        topExpenseEl.textContent = 'â€”';
                    }
                }
                
                // Load recent activity
                await loadRecentActivity();
                
                // Load AI Insight with full transaction data
                await loadDashboardInsight({
                    summary: {
                        totalIncome,
                        totalExpenses,
                        netProfit,
                        trips: totalTrips,
                        hours: totalHours,
                        miles: totalMiles
                    },
                    recentIncome: incomeData.slice(0, 10), // Last 10 income entries
                    recentExpenses: expenseData.slice(0, 10) // Last 10 expense entries
                });
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        // ============================================
        // Load Dashboard AI Insight
        // ============================================
        
        async function loadDashboardInsight(data) {
            try {
                // Show loading state
                displayInsight('ai-insight-container', '', true);
                
                // Generate insight
                const insight = await generateAIInsight('dashboard', data);
                
                // Display insight
                displayInsight('ai-insight-container', insight, false);
                
            } catch (error) {
                console.error('Error loading AI insight:', error);
                // Hide container on error
                document.getElementById('ai-insight-container').innerHTML = '';
            }
        }
        
        // Refresh insight function (called from UI)
        async function refreshInsight() {
            clearInsightCache('dashboard');
            // Reload dashboard data to get fresh insight
            await loadDashboardData();
        }
        
        // ============================================
        // Load Balance Sheet Data
        // ============================================
        
        async function loadBalanceSheetData() {
            if (!currentUser) return;
            
            try {
                // Fetch assets
                const { data: assetsData, error: assetsError } = await supabase
                    .from('assets')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (assetsError) throw assetsError;
                
                // Fetch liabilities
                const { data: liabilitiesData, error: liabilitiesError } = await supabase
                    .from('liabilities')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (liabilitiesError) throw liabilitiesError;
                
                // Fetch owner equity
                const { data: equityData, error: equityError } = await supabase
                    .from('owner_equity')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (equityError) {
                    console.log('Owner equity table not found or error:', equityError);
                    // Continue without equity data
                }
                
                // Calculate totals
                const totalAssets = assetsData ? assetsData.reduce((sum, asset) => sum + parseFloat(asset.current_value || 0), 0) : 0;
                const totalLiabilities = liabilitiesData ? liabilitiesData.reduce((sum, liability) => sum + parseFloat(liability.current_balance || 0), 0) : 0;
                
                // Calculate equity
                let totalContributions = 0;
                let totalDraws = 0;
                if (equityData) {
                    totalContributions = equityData
                        .filter(e => e.transaction_type === 'contribution')
                        .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                    totalDraws = equityData
                        .filter(e => e.transaction_type === 'draw')
                        .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                }
                const netEquity = totalContributions - totalDraws;
                
                // Calculate net worth
                const netWorth = totalAssets - totalLiabilities;
                
                // Hide loading skeletons
                document.getElementById('dashboard-total-assets-loading')?.classList.add('hidden');
                document.getElementById('dashboard-total-liabilities-loading')?.classList.add('hidden');
                document.getElementById('dashboard-net-equity-loading')?.classList.add('hidden');
                document.getElementById('dashboard-net-worth-loading')?.classList.add('hidden');
                
                // Update and show dashboard cards
                const dashboardTotalAssets = document.getElementById('dashboard-total-assets');
                const dashboardTotalLiabilities = document.getElementById('dashboard-total-liabilities');
                const dashboardNetEquity = document.getElementById('dashboard-net-equity');
                const dashboardNetWorth = document.getElementById('dashboard-net-worth');
                
                if (dashboardTotalAssets) {
                    dashboardTotalAssets.textContent = formatCurrencyDisplay(totalAssets);
                    dashboardTotalAssets.classList.remove('hidden');
                }
                if (dashboardTotalLiabilities) {
                    dashboardTotalLiabilities.textContent = formatCurrencyDisplay(totalLiabilities);
                    dashboardTotalLiabilities.classList.remove('hidden');
                }
                if (dashboardNetEquity) {
                    dashboardNetEquity.textContent = formatCurrencyDisplay(netEquity);
                    dashboardNetEquity.classList.remove('hidden');
                }
                if (dashboardNetWorth) {
                    dashboardNetWorth.textContent = formatCurrencyDisplay(netWorth);
                    dashboardNetWorth.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error loading balance sheet data:', error);
            }
        }
        
        // ============================================
        // Load Recent Activity with Pagination
        // ============================================
        
        let allActivityData = [];
        let currentActivityPage = 1;
        const itemsPerPage = 10;
        
        async function loadRecentActivity() {
            if (!currentUser) return;
            
            try {
                // Get date range from filter
                const dateRange = getDashboardDateRange();
                
                // Fetch income with date filter
                let incomeQuery = supabase
                    .from('income')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (dateRange.start) {
                    incomeQuery = incomeQuery.gte('date', dateRange.start);
                }
                if (dateRange.end) {
                    incomeQuery = incomeQuery.lte('date', dateRange.end);
                }
                
                const { data: recentIncome, error: incomeError } = await incomeQuery
                    .order('created_at', { ascending: false })
                    .limit(100); // Fetch more for pagination
                
                if (incomeError) throw incomeError;
                
                // Fetch expenses with date filter
                let expenseQuery = supabase
                    .from('expenses')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (dateRange.start) {
                    expenseQuery = expenseQuery.gte('date', dateRange.start);
                }
                if (dateRange.end) {
                    expenseQuery = expenseQuery.lte('date', dateRange.end);
                }
                
                const { data: recentExpenses, error: expenseError } = await expenseQuery
                    .order('created_at', { ascending: false })
                    .limit(100); // Fetch more for pagination
                
                if (expenseError) throw expenseError;
                
                // Combine and sort by date
                allActivityData = [
                    ...recentIncome.map(item => ({ ...item, type: 'income' })),
                    ...recentExpenses.map(item => ({ ...item, type: 'expense' }))
                ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Reset to page 1 when data reloads
                currentActivityPage = 1;
                
                // Render the first page
                renderActivityPage();
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recent-activity').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p>Error loading activity</p>
                    </div>
                `;
            }
        }
        
        function renderActivityPage() {
            const activityContainer = document.getElementById('recent-activity');
            const paginationContainer = document.getElementById('activity-pagination');
            const activityCount = document.getElementById('activity-count');
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            // Update count
            if (activityCount) {
                activityCount.textContent = `${allActivityData.length} item${allActivityData.length !== 1 ? 's' : ''}`;
            }
            
            // Handle empty state
            if (allActivityData.length === 0) {
                activityContainer.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500 mb-4">No activity yet</p>
                        <button onclick="openIncomeModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">
                            Add Your First Entry
                        </button>
                    </div>
                `;
                if (paginationContainer) paginationContainer.classList.add('hidden');
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(allActivityData.length / itemsPerPage);
            const startIndex = (currentActivityPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = allActivityData.slice(startIndex, endIndex);
            
            // Update pagination info
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentActivityPage} of ${totalPages}`;
            }
            
            // Update button states
            if (prevBtn) {
                prevBtn.disabled = currentActivityPage === 1;
            }
            if (nextBtn) {
                nextBtn.disabled = currentActivityPage === totalPages;
            }
            
            // Show/hide pagination
            if (paginationContainer) {
                if (totalPages > 1) {
                    paginationContainer.classList.remove('hidden');
                } else {
                    paginationContainer.classList.add('hidden');
                }
            }
            
            // Render activity items
            activityContainer.innerHTML = pageData.map(item => {
                const isIncome = item.type === 'income';
                const icon = isIncome ? getSourceIcon(item.source) : getCategoryIcon(item.category);
                const title = isIncome ? item.source : (item.vendor || item.category);
                const subtitle = formatDate(item.created_at);
                const amount = parseFloat(item.amount);
                const formattedAmount = formatCurrencyDisplay(amount);
                const amountColor = isIncome ? 'text-accent' : 'text-danger';
                const bgColor = isIncome ? 'bg-green-100' : 'bg-red-100';
                const iconColor = isIncome ? 'text-green-600' : 'text-red-600';
                
                // Additional details
                let details = '';
                if (isIncome) {
                    const tripInfo = [];
                    if (item.trip_count) tripInfo.push(`${item.trip_count} trips`);
                    if (item.hours_worked) tripInfo.push(`${formatNumber(item.hours_worked)}h`);
                    if (item.miles_driven) tripInfo.push(`${formatNumber(item.miles_driven)} mi`);
                    if (tripInfo.length > 0) {
                        details = `<span class="text-xs text-gray-400 ml-1">â€¢ ${tripInfo.join(' â€¢ ')}</span>`;
                    }
                } else if (item.description) {
                    details = `<span class="text-xs text-gray-400 ml-1">â€¢ ${item.description.substring(0, 30)}${item.description.length > 30 ? '...' : ''}</span>`;
                }
                
                return `
                    <div class="activity-item flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 hover:shadow-sm transition-all duration-200 border border-transparent hover:border-gray-200">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 ${bgColor} rounded-lg flex items-center justify-center ${iconColor} flex-shrink-0">
                                ${icon}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-900 truncate">${title}</p>
                                <div class="flex items-center text-xs text-gray-500">
                                    <span>${subtitle}</span>
                                    ${details}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 ml-4 flex-shrink-0">
                            <span class="text-lg font-bold ${amountColor}">${isIncome ? '+' : '-'}${formattedAmount}</span>
                            <div class="flex items-center gap-1">
                                <button data-action="edit" data-type="${item.type}" data-id="${item.id}" class="activity-edit-btn p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button data-action="delete" data-type="${item.type}" data-id="${item.id}" data-title="${title.replace(/"/g, '&quot;')}" data-amount="${amount}" class="activity-delete-btn p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function changeActivityPage(direction) {
            const totalPages = Math.ceil(allActivityData.length / itemsPerPage);
            currentActivityPage += direction;
            
            // Ensure we stay within bounds
            if (currentActivityPage < 1) currentActivityPage = 1;
            if (currentActivityPage > totalPages) currentActivityPage = totalPages;
            
            // Render the new page
            renderActivityPage();
            
            // Scroll to top of activity section
            document.getElementById('recent-activity').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // ============================================
        // Edit & Delete Activity - Event Delegation
        // ============================================
        
        // Use event delegation for dynamically added buttons
        document.addEventListener('click', function(e) {
            // Handle edit button clicks
            if (e.target.closest('.activity-edit-btn')) {
                const btn = e.target.closest('.activity-edit-btn');
                const type = btn.dataset.type;
                const id = btn.dataset.id;
                console.log('Edit clicked:', type, id); // Debug log
                editActivity(type, id);
            }
            
            // Handle delete button clicks
            if (e.target.closest('.activity-delete-btn')) {
                const btn = e.target.closest('.activity-delete-btn');
                const type = btn.dataset.type;
                const id = btn.dataset.id;
                const title = btn.dataset.title;
                const amount = btn.dataset.amount;
                console.log('Delete clicked:', type, id); // Debug log
                deleteActivity(type, id, title, amount);
            }
        });
        
        function editActivity(type, id) {
            console.log('editActivity called:', type, id); // Debug log
            if (type === 'income') {
                // Open income modal in edit mode (keep as string for UUID)
                openIncomeModal(id);
            } else if (type === 'expense') {
                // Open expense modal in edit mode (keep as string for UUID)
                openExpenseModal(id);
            }
        }
        
        // ============================================
        // Delete Activity
        // ============================================
        
        async function deleteActivity(type, id, title, amount) {
            const typeLabel = type === 'income' ? 'income' : 'expense';
            const formattedAmount = formatCurrencyDisplay(amount);
            
            if (!confirm(`Are you sure you want to delete this ${typeLabel}?\n\n${title}\n${formattedAmount}\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const tableName = type === 'income' ? 'income' : 'expenses';
                
                const { error } = await supabase
                    .from(tableName)
                    .delete()
                    .eq('id', id)
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                // Reload dashboard data
                await loadDashboardData();
                
            } catch (error) {
                console.error(`Error deleting ${typeLabel}:`, error);
                alert(`Failed to delete ${typeLabel}. Please try again.`);
            }
        }
        
        // ============================================
        // Tooltip Functions
        // ============================================
        
        
        // ============================================
        // Trend Calculation
        // ============================================
        
        async function calculateTrends() {
            try {
                // Get current month data
                const now = new Date();
                const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const currentMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                
                // Get last month data
                const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
                const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
                
                // Fetch last month income
                const { data: lastMonthIncome } = await supabase
                    .from('income')
                    .select('amount')
                    .eq('user_id', currentUser.id)
                    .gte('date', lastMonthStart)
                    .lte('date', lastMonthEnd);
                
                // Fetch last month expenses
                const { data: lastMonthExpenses } = await supabase
                    .from('expenses')
                    .select('amount')
                    .eq('user_id', currentUser.id)
                    .gte('date', lastMonthStart)
                    .lte('date', lastMonthEnd);
                
                const lastIncome = (lastMonthIncome || []).reduce((sum, item) => sum + parseFloat(item.amount), 0);
                const lastExpenses = (lastMonthExpenses || []).reduce((sum, item) => sum + parseFloat(item.amount), 0);
                const lastProfit = lastIncome - lastExpenses;
                
                // Get current totals from DOM
                const currentIncome = parseFloat(document.getElementById('total-income').textContent.replace(/[$,]/g, '')) || 0;
                const currentExpenses = parseFloat(document.getElementById('total-expenses').textContent.replace(/[$,]/g, '')) || 0;
                const currentProfit = parseFloat(document.getElementById('net-profit').textContent.replace(/[$,]/g, '')) || 0;
                
                // Calculate percentage changes
                updateTrendBadge('income-trend', currentIncome, lastIncome, 'green');
                updateTrendBadge('expense-trend', currentExpenses, lastExpenses, 'red');
                updateTrendBadge('profit-trend', currentProfit, lastProfit, 'white');
                
            } catch (error) {
                console.error('Error calculating trends:', error);
            }
        }
        
        function updateTrendBadge(elementId, current, previous, color) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (previous === 0) {
                element.innerHTML = '';
                return;
            }
            
            const change = ((current - previous) / previous) * 100;
            const isPositive = change > 0;
            const arrow = isPositive ? 'â–²' : 'â–¼';
            const colorClass = color === 'green' 
                ? (isPositive ? 'text-green-600' : 'text-red-600')
                : color === 'red'
                ? (isPositive ? 'text-red-600' : 'text-green-600')
                : (isPositive ? 'text-white' : 'text-white/80');
            
            element.innerHTML = `<span class="${colorClass}">${arrow} ${Math.abs(change).toFixed(0)}%</span>`;
        }
        
        // ============================================
        // Helper Functions
        // ============================================
        
        function getSourceIcon(source) {
            const iconMap = {
                'Rideshare Trip': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Black Car Service': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Private Client': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Delivery': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Other': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>'
            };
            return iconMap[source] || '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }
        
        function getCategoryIcon(category) {
            const iconMap = {
                'Gas': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Tolls': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Parking': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Car Wash': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Maintenance & Repairs': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Insurance': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Car Payment': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Phone Bill': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Supplies': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>',
                'Other': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>'
            };
            return iconMap[category] || '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today, ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'Yesterday, ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (diffDays < 7) {
                return diffDays + ' days ago';
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        
        // ============================================
        // Number Formatting - Global Functions
        // ============================================
        
        // Format number with commas (e.g., 1200 -> 1,200)
        function formatNumber(number) {
            if (number === null || number === undefined || isNaN(number)) {
                return '0';
            }
            return parseFloat(number).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }
        
        // Format currency with dollar sign and commas (e.g., 1200 -> $1,200.00)
        function formatCurrencyDisplay(number) {
            if (number === null || number === undefined || isNaN(number)) {
                return '$0.00';
            }
            return '$' + parseFloat(number).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // ============================================
        // Animated Number Counter
        // ============================================
        
        function animateNumber(element, targetValue, duration = 1000, prefix = '$', decimals = 2) {
            if (!element) return;
            
            const startValue = 0;
            const startTime = performance.now();
            
            // Easing function for smooth animation
            function easeOutQuart(x) {
                return 1 - Math.pow(1 - x, 4);
            }
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Apply easing
                const easedProgress = easeOutQuart(progress);
                const currentValue = startValue + (targetValue - startValue) * easedProgress;
                
                // Format the number
                const formattedValue = currentValue.toLocaleString('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
                
                element.textContent = prefix + formattedValue;
                
                // Continue animation if not complete
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }
        
        // Helper function to animate currency values
        function animateCurrency(elementId, value) {
            const element = document.getElementById(elementId);
            if (element && value !== null && value !== undefined && !isNaN(value)) {
                animateNumber(element, parseFloat(value), 1000, '$', 2);
            }
        }
        
        // Format input field with commas as user types
        function formatCurrency(input) {
            // Get the input value and remove all non-digit characters
            let value = input.value.replace(/[^\d]/g, '');
            
            // If empty, leave it empty
            if (!value) {
                input.value = '';
                return;
            }
            
            // Convert to number and format with commas
            let number = parseInt(value);
            let formatted = number.toLocaleString('en-US');
            
            // Update the input value
            input.value = formatted;
        }
        
        function unformatCurrency(input) {
            // Remove commas for form submission
            return input.value.replace(/,/g, '');
        }
        
        // Add formatting to income amount field
        const incomeAmountInput = document.getElementById('income-amount');
        incomeAmountInput.addEventListener('input', function(e) {
            formatCurrency(this);
        });
        
        // Add formatting to expense amount field
        const expenseAmountInput = document.getElementById('expense-amount');
        expenseAmountInput.addEventListener('input', function(e) {
            formatCurrency(this);
        });
        
        // ============================================
        // Initialize
        // ============================================
        
        checkAuth();
    </script>
    
    <!-- Smart Modal Enhancements -->
    <script src="dashboard-smart-modals.js"></script>
</body>
</html>
